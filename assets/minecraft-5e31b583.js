var Yt=Object.defineProperty;var zt=(r,e,t)=>e in r?Yt(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var q=(r,e,t)=>(zt(r,typeof e!="symbol"?e+"":e,t),t),ut=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var W=(r,e,t)=>(ut(r,e,"read from private field"),t?t.call(r):e.get(r)),te=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)};var Ne=(r,e,t)=>(ut(r,e,"access private method"),t);import"./modulepreload-polyfill-3cfb730f.js";function It(r=null){if(r)for(let e of[{pname:"MAX_TEXTURE_SIZE",min:0},{pname:"MAX_3D_TEXTURE_SIZE",min:256},{pname:"MAX_ARRAY_TEXTURE_LAYERS",min:512},{pname:"MAX_DRAW_BUFFERS",min:4},{pname:"MAX_COLOR_ATTACHMENTS",min:4},{pname:"MAX_VERTEX_UNIFORM_BLOCKS",min:12},{pname:"MAX_VERTEX_TEXTURE_IMAGE_UNITS",min:16},{pname:"MAX_FRAGMENT_INPUT_COMPONENTS",min:60},{pname:"MAX_UNIFORM_BUFFER_BINDINGS",min:24},{pname:"MAX_COMBINED_UNIFORM_BLOCKS",min:24}]){let t=r.getParameter(r[e.pname]);if(typeof t!="number"||Number.isNaN(t)||t<e.min){r=null;break}}return!!r}let We=navigator.userAgent.toLowerCase();window.isTouchDevice=["android","ucweb","iphone os","ipad","ipod","windows phone os","windows ce","windows mobile","midp","symbianos","blackberry","hpwos","rv:1.2.3.4"].some(r=>We.includes(r));!isTouchDevice&&We.includes("safari")&&We.includes("version")&&!We.includes("iphone")&&"ontouchend"in document&&(window.isTouchDevice=!0);window.isSupportWebGL2=(()=>{let r=null;try{r=document.createElement("canvas").getContext("webgl2")}catch{r=null}return It(r)})();class be{constructor(){this._listeners={},this._IDcount=0n,this._IDmap=new Map}hasEventListener(e,t){return!!(this._listeners[e]&&this._listeners[e].find(i=>i.listener===t))}addEventListener(e,t,{once:i=!1}={}){if(typeof t!="function")return console.warn("Cannot bind a non-function as an event listener!");const s=this._listeners[e]||[];this._listeners[e]=s;let n=s.findIndex(h=>h.listener===t);if(n!==-1)return this._IDmap[s[n].id];let a={listener:t,once:i,type:e,id:this._IDcount++};return this._IDmap.set(a.id,a),s.push(a),a.id}removeEventListenerByID(e){if(typeof e!="bigint"||!this._IDmap.has(e))return!1;let t=this._IDmap.get(e);this._IDmap.delete(e);let i=this._listeners[t.type];return i.splice(i.indexOf(t),1),!0}removeEventListener(e,t){if(this.removeEventListenerByID(e))return!0;const i=e;if(!(i in this._listeners))return!1;let s=this._listeners[i],n=s.findIndex(a=>a.listener===t);return n!==-1&&(this._IDmap.delete(s[n].id),s.splice(n,1)),!0}dispatchEvent(e,...t){if(e in this._listeners)return this._listeners[e].slice(0).map(i=>{i.listener(...t),i.once&&this.removeEventListenerByID(i.id)})}}class Gt{constructor(){this._eventDispatchers={}}hasEventDispatcher(e){return!!this._eventDispatchers[e]}addEventDispatcher(e,t=new be){return this._eventDispatchers[e]=t}getOrNewEventDispatcher(e){return e in this._eventDispatchers||this.addEventDispatcher(e),this._eventDispatchers[e]}removeEventDispatcher(e){delete this._eventDispatchers[e]}}const pe=new Gt,Rt=(r,e)=>new Promise((t,i)=>{const s=new XMLHttpRequest;s.onreadystatechange=function(){this.readyState===4&&(this.status===200?t(this.response):i(new Error(this.statusText)))},s.responseType=e,s.open("GET",r),s.send()}),$t=r=>Rt(r,"json"),Vt=r=>Rt(r,"text"),jt=r=>new Promise((e,t)=>{const i=new Image;i.onload=function(){this.uri=r,e(this)},i.onerror=t,i.src=r}),Zt=r=>{let[e,t,i]=r.match(/([^\\\/<>|:"*?]+)\.(\w+$)/);return[e||"",t||"",i||""]},Te={},qt=pe.getOrNewEventDispatcher("mc.load"),fe={},Qe=r=>{let e=new Promise((t,i)=>{r in Te?t(Te[r]):r in fe?fe[r].push({resolve:t,reject:i}):fe[r]=[{resolve:t,reject:i}]});return qt.dispatchEvent("newAwaitRes",r,e),e},et=(r,e,{status:t="resolve",type:i=""}={})=>{t==="resolve"&&(Te[r]=e),r in fe&&(fe[r].forEach(s=>s[t](e,t,r,i)),t==="resolve"&&delete fe[r])},Re=(r,e)=>et(r,e),tt=r=>Qe(r),ce=(r,{type:e={png:"img",json:"json"}[Zt(r)[2].toLowerCase()]||"text"}={})=>{if(r in Te)return Promise.resolve(Te[r]);let t=[i=>et(r,i,{type:e}),i=>et(r,i,{type:e,status:"reject"})];return r in fe||(e==="img"||e==="png"?jt(r).then(...t):e==="json"?$t(r).then(...t):e==="text"&&Vt(r).then(...t)),Qe(r)},Me={};Re("MCComponent",Me);const Ue=r=>new Promise(e=>setTimeout(e,r));class ne extends HTMLElement{static setBorderAndWaitImg(e,t="."+e,i={}){"preloadStyleRules"in this||(this.preloadStyleRules=[]),e.startsWith("mc-ui-")||(e="mc-ui-"+e+"-img");const s="keepCenter"in i?i.keepCenter:!0;delete i.keepCenter,i={...i,"border-color":"transparent","border-style":"solid","border-image":`var(--${e})
                var(--${e}-border-top)
                var(--${e}-border-right)
                var(--${e}-border-bottom)
                var(--${e}-border-left)
                ${s?"fill":""} stretch`};let n=t+` {
`+Object.entries(i).map(([a,h])=>`${a}: ${h};`).join(`
`)+`
}`;return this.preloadStyleRules.push(n),tt(e)}static setBackgroundAndWaitImg(e,t="."+e,i={}){"preloadStyleRules"in this||(this.preloadStyleRules=[]),e.startsWith("mc-ui-")||(e="mc-ui-"+e+"-img"),(a=>Object.entries(a).forEach(([h,l])=>i[h]=i[h]||l))({"background-image":`var(--${e})`,"background-size":"cover","background-repeat":"no-repeat"});let n=t+` {
`+Object.entries(i).map(([a,h])=>`${a}: ${h};`).join(`
`)+`
}`;return this.preloadStyleRules.push(n),tt(e)}static genTemplate(e,t=e){if(Me[t])return Me[t];let i=document.createElement("template");return i.innerHTML=(this.preloadStyleRules?"<style> "+this.preloadStyleRules.join(`
`)+"</style>":"")+e,Me[t]=i,i}static get templateUrlPrefix(){return"src/UI/components/"}static get templateUrlFilename(){return this.name}static get templateUrl(){return this.templateUrlPrefix+this.templateUrlFilename+".html"}static asyncLoadTemplateByUrl(e=this.templateUrl){return ce(e).then(t=>{if(typeof t!="string")return t;let i=this.genTemplate(t,e);return Re(e,i),i})}static get componentName(){return this.name.replace(/([A-Z]+|[a-z])([A-Z])/g,"$1-$2").toLowerCase()}static define(e=this.componentName){if(!e)throw"Component registration failed: Missing componentName.";return customElements.define(e,this)}static asyncLoadAndDefine(){return this.asyncLoadTemplateByUrl().then(e=>this.define())}static getTemplateByUrl(e=this.templateUrl){return Me[e]}get template(){return this.constructor.getTemplateByUrl()}appendTemplate(e=this.template){return e.content?this.shadowRoot.appendChild(e.content.cloneNode(!0)):null}constructor(){if(super(),new.target.name==="MCComponent")throw"Class 'MCComponent' cannot be instantiated!";this.attachShadow({mode:"open"}),this.template&&this.appendTemplate()}async connectedCallback(...e){this.onConnected&&(await Ue(0),this.onConnected(...e))}async disconnectedCallback(...e){this.onDisconnected&&(await Ue(0),this.onDisconnected(...e))}async adoptedCallback(...e){this.onAdopted&&(await Ue(0),this.onAdopted(...e))}async attributeChangedCallback(...e){e[1]!==e[2]&&this.onAttrChanged&&(await Ue(0),this.onAttrChanged(...e))}dispatchEvent(e,{global:t=!1,data:i={}}={}){return e instanceof Event?super.dispatchEvent(e):super.dispatchEvent(new CustomEvent(e,{...t?{bubbles:!0,cancelable:!0,composed:!0}:{},detail:i}))}}class Kt extends be{constructor({id:e="",initial:t="",transitions:i=[]}={}){super(),this.id=e,this.initial=t,this.currentState=t,this.graph={},this.addTransitions(i)}addTransitions(e){e.forEach(t=>this.addTransition(t))}addTransition({from:e,to:t,eventName:i=e+"=>"+t}={}){this.graph[e]=this.graph[e]||{},this.graph[t]=this.graph[t]||{},this.graph[e][t]=i}transition(e,...t){const i=this.currentState;if(!(i in this.graph))return console.error(`FSM: cannot find state "${i}"`);if(!(e in this.graph))return console.error(`FSM: cannot find state "${e}"`);if(!(e in this.graph[i]))return console.error(`FSM: cannot find transition "${i}" => "${e}"`);const s=this.graph[i][e];this.currentState=e,this.dispatchEvent(s,...t),this.dispatchEvent("transitioned",i,e,s,...t)}}pe.getOrNewEventDispatcher("mc.preload").addEventListener("done",()=>{history.pushState(null,document.title),window.addEventListener("popstate",r=>{history.pushState(null,document.title),window.dispatchEvent(new Event("back"))},!1),window.addEventListener("exit",r=>{history.go(-2)})},{once:!0});class Jt extends Kt{constructor(){super({id:"pageManager",initial:"preload"}),pe.addEventDispatcher("mc.page",this)}getCurrentPage(){return document.body.lastChild}getPageByID(e){return e="mcpage-"+e,[...document.body.childNodes].reverse().find(i=>i.pageID==e)||null}openPageByID(e,...t){if(e==="*pop")return this.closeCurrentPage();let i=this.getCurrentPage(),s=document.createElement("mcpage-"+e);return document.body.appendChild(s),this.dispatchEvent("opened",s,...t),this.transition(e,i,s,...t),s}closePage(e,...t){if(e==="*pop")return this.closeCurrentPage(...t);let i=this.getPageByID(e);return i?i===this.getCurrentPage()?this.closeCurrentPage(...t):(document.body.removeChild(i),this.dispatchEvent("closed",i,...t),i):null}closeCurrentPage(...e){let t=this.getCurrentPage();document.body.removeChild(t),this.dispatchEvent("closed",t,...e);let i=this.getCurrentPage();return this.transition(i.shortPageID,t,i,...e),t}}const O=new Jt;let lt=document.createElement("style");lt.innerHTML=`
    :host {
        width: 100vw;
        height: 100vh;
        position: absolute;
        top: 0; left: 0;
    }
`;lt.id="pageStyle";class re extends ne{static get pm(){return O}static get pageManager(){return O}static get shortPageID(){return super.componentName.replace(/-page$/,"")}static get pageID(){return"mcpage-"+this.shortPageID}static get componentName(){return this.pageID}static get templateUrlPrefix(){return"src/UI/pages/"}static get outdegree(){return[]}get shortPageID(){return this.constructor.shortPageID}get pageID(){return this.constructor.pageID}get outdegree(){return this.constructor.outdegree}constructor(){if(super(),new.target.name==="Page")throw"Class 'Page' cannot be instantiated!";O.addTransitions(this.outdegree.map(e=>({from:this.shortPageID,to:e}))),this.onHistoryBack=this.onHistoryBack.bind(this),this._transitionedCallbackID=O.addEventListener("transitioned",(e,t,i,s,n,...a)=>{this.onTransitioned(e,t,i,s,n,...a),s===this?(this.onTransitionedFromThis(t,i,n,...a),window.removeEventListener("back",this.onHistoryBack)):n===this&&(this.onTransitionedToThis(e,i,s,...a),window.addEventListener("back",this.onHistoryBack))})}onTransitioned(e,t,i,s,n,...a){}onTransitionedFromThis(e,t,i,...s){}onTransitionedToThis(e,t,i,...s){}onHistoryBack(){}async disconnectedCallback(){await super.disconnectedCallback(),O.removeEventListenerByID(this._transitionedCallbackID),window.removeEventListener("back",this.onHistoryBack)}appendTemplate(e=this.template){let t=super.appendTemplate(e);if(t)return this.shadowRoot.prepend(lt.cloneNode(!0)),customElements.whenDefined("mc-full-screen-button").then(i=>{this.shadowRoot.append(document.createElement("mc-full-screen-button"))}),t}close(...e){O.closePage(this.shortPageID,...e)}}let dt=!1,Ze=0,qe=0;const oe={},it=r=>new Promise(e=>setTimeout(e,r));pe.getOrNewEventDispatcher("mc.load").addEventListener("newAwaitRes",function r(e,t){let i=document.getElementsByTagName("mcpage-preload")[0],s=i.querySelector("[slot=loading]"),n=i.querySelector("[slot=loaded]"),a;e in oe?a=[...s.childNodes].find(h=>h.innerHTML.startsWith(e)):(++qe,i.setProgress(Ze,qe),a=document.createElement("li"),s.appendChild(a)),oe[e]=(oe[e]||0)+1,a.innerHTML=e+" ("+oe[e]+")",t.then(async h=>{if(await it(600),a.innerHTML=e+" ("+--oe[e]+")",oe[e]==0&&(++Ze,i.setProgress(Ze,qe),n.appendChild(a)),!dt){for(let l in oe)if(oe[l])return;dt=!0,pe.getOrNewEventDispatcher("mc.preload").dispatchEvent("done",Te),pe.getOrNewEventDispatcher("mc.load").removeEventListener("newAwaitRes",r)}},h=>{console.error("preload failed: "+e,h)})});pe.getOrNewEventDispatcher("mc.preload").addEventListener("done",async()=>{await it(777),O.openPageByID("welcome");const r=document.querySelector("mcpage-preload");r.style.opacity=0,await it(1100),O.closePage("preload")},{once:!0});const Ce=document.createElement("template");let Oe=!0;class Qt extends re{static get outdegree(){return["welcome"]}get template(){return Oe?null:Ce}onConnected(){if(!Oe)return;Oe=!1;let e=document.getElementById(this.pageID),t=new RegExp(this.pageID,"g");e.innerHTML=e.innerHTML.replace(t,":host"),e.removeAttribute("id"),e.parentElement.removeChild(e),Ce.content.appendChild(e),[...this.querySelectorAll("mcpage-preload > :not([slot])")].forEach(i=>Ce.content.appendChild(i)),Ce.id=this.pageID,this.appendTemplate(document.head.appendChild(Ce))}async setProgress(e,t){const i=Oe?this:this.shadowRoot;let s=i.querySelector("progress");s.value=e,s.max=t,i.querySelector(".loadingCount").innerHTML=e,i.querySelector(".loadedCount").innerHTML=t}}Qt.define();class ei extends be{_getStorage(){return JSON.parse(localStorage.getItem("mcSettings")||"{}")}_setStorage(e){localStorage.setItem("mcSettings",JSON.stringify(e))}_changeProp(e,t){const i=this._getStorage();i[e]=t,this._setStorage(i),this.dispatchEvent("changedValue",e,t)}constructor(){super();const e=this._getStorage();this._addNumberProp("fov",30,110,60,e.fov),this._addNumberProp("mousemoveSensitivity",60,800,200,e.mousemoveSensitivity),this._addNumberProp("renderDistance",1,32,4,e.renderDistance),this._addNumberProp("homepageBlur",0,10,3.5,e.homepageBlur),this._addBoolProp("shade",!0,e.shade),this._addBoolProp("showDebugOutput",!1,e.showDebugOutput)}_addNumberProp(e,t,i,s,n=s){Object.defineProperty(this,"_"+e,{value:{type:"number",min:t,max:i,defaultVal:s,currentVal:n}}),Object.defineProperty(this,e,{enumerable:!0,get:()=>this["_"+e].currentVal,set:a=>{let h=this["_"+e];h.currentVal=Math.max(h.min,Math.min(h.max,a)),this._changeProp(e,h.currentVal)}}),Object.defineProperty(this,e+"Min",{get:()=>this["_"+e].min,set:a=>o.min=a}),Object.defineProperty(this,e+"Max",{get:()=>this["_"+e].max,set:a=>o.max=a}),Object.defineProperty(this,e+"Default",{get:()=>this["_"+e].defaultVal,set:a=>o.defaultVal=a})}_addBoolProp(e,t,i=t){Object.defineProperty(this,"_"+e,{value:{type:"boolean",defaultVal:t,currentVal:i}}),Object.defineProperty(this,e,{enumerable:!0,get:()=>this["_"+e].currentVal,set:s=>{let n=this["_"+e];n.currentVal=!!s,this._changeProp(e,n.currentVal)}}),Object.defineProperty(this,e+"Default",{get:()=>this["_"+e].defaultVal,set:s=>o.defaultVal=s})}}const U=new ei,ke={};function ht(r,e=Array,t={}){if(r in ke)return ke[r];const i={},s=ke[r]=(n=e(),a=!0,h=!0)=>{let l=new Proxy(n,{get(c,u,p){if(u in i){const f=i[u];return(...m)=>{let{input:d,output:g}=f;d<g,d&&a?m.splice(d-1,0,c)&&h&&m.splice(g+1,0,c):h&&m.splice(g,0,c);let y=f(...m);return h?l:ke[f.outputType](y,a,h)||ke[r](y,a,h)}}else switch(u){case"b2i":case"bind2in":return a=!0,l;case"b2o":case"bind2out":return h=!0,l;case"ub2i":case"unbind2in":return a=!1,l;case"ub2o":case"unbind2out":return h=!1,l;case"ans":case"answer":case"res":case"result":return c;default:return Reflect.get(c,u,p)}}});return l};return s._define=function(n,a,{input:h=1,output:l=-1,outputType:c=r,argsLen:u=a.length+1,derived:p={}}={}){return typeof n=="string"&&(n=[n]),a.argsLen=u,a.input=h<0?u+h+1:h,a.output=l<0?u+l+1:l,a.outputType=c,n.forEach(f=>{Object.defineProperty(s,f,{value:a,configurable:!0,writable:!0,enumerable:!0}),i[f]=a}),Object.entries(p).forEach(([f,{fn:m,input:d=h,output:g=l,alias:y=[]}])=>{const v=m?(...w)=>m(...w,a(...w)):a.bind();v.input=d<0?u+d+1:d,v.output=g<0?u+g+1:g,v.outputType=c,i[f]=v,y.forEach(w=>i[w]=v)}),s},Object.entries(t).forEach(([n,a])=>{const h=a.alias||[];h.unshift(n),s._define(h,a.fn,a)}),s}const{PI:St}=Math,le=1e-5,_t=r=>r*St/180,pt=r=>r*180/St,ti=(r,e)=>r.reduce((t,i,s)=>t+Math.abs(i-e[s]),0);let K=window.Float32Array||Array;const H=ht("Mat4",()=>new K(16),{getArrType:{fn:()=>K,input:0,output:0,argsLen:0},setArrType:{fn(r){K=r},input:0,output:0,argsLen:1},identity:{alias:["E"],fn(r=new K(16)){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},input:0},copy:{alias:["copyTo","copy2","clone"],fn(r,e=new K(16)){return r===e||(e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]),e},derived:{copyFrom:{alias:["set","="],fn:r=>r,input:2,output:1}}},multiply:{alias:["mul","preMultiply","preMul","leftMultiply","leftMul","*"],fn([r,e,t,i,s,n,a,h,l,c,u,p,f,m,d,g],[y,v,w,E,A,k,T,b,B,x,M,S,P,F,R,D],_=new K(16)){return _[0]=y*r+v*s+w*l+E*f,_[1]=y*e+v*n+w*c+E*m,_[2]=y*t+v*a+w*u+E*d,_[3]=y*i+v*h+w*p+E*g,_[4]=A*r+k*s+T*l+b*f,_[5]=A*e+k*n+T*c+b*m,_[6]=A*t+k*a+T*u+b*d,_[7]=A*i+k*h+T*p+b*g,_[8]=B*r+x*s+M*l+S*f,_[9]=B*e+x*n+M*c+S*m,_[10]=B*t+x*a+M*u+S*d,_[11]=B*i+x*h+M*p+S*g,_[12]=P*r+F*s+R*l+D*f,_[13]=P*e+F*n+R*c+D*m,_[14]=P*t+F*a+R*u+D*d,_[15]=P*i+F*h+R*p+D*g,_},derived:{postMultiply:{input:2,alias:["rightMultiply","rightMul","postMul"]}}},scale:{fn(r,[e,t,i],s=new K(16)){const[n,a,h,l,c,u,p,f,m,d,g,y,v,w,E,A]=r;return s[0]=n*e,s[1]=a*e,s[2]=h*e,s[3]=l*e,s[4]=c*t,s[5]=u*t,s[6]=p*t,s[7]=f*t,s[8]=m*i,s[9]=d*i,s[10]=g*i,s[11]=y*i,r!==s&&(s[12]=v,s[13]=w,s[14]=E,s[15]=A),s}},translate:{fn(r,[e,t,i],s=new K(16)){const[n,a,h,l,c,u,p,f,m,d,g,y,v,w,E,A]=r;return r!==s&&(s[0]=n,s[1]=a,s[2]=h,s[3]=l,s[4]=c,s[5]=u,s[6]=p,s[7]=f,s[8]=m,s[9]=d,s[10]=g,s[11]=y),s[12]=v+n*e+c*t+m*i,s[13]=w+a*e+u*t+d*i,s[14]=E+h*e+p*t+g*i,s[15]=A+l*e+f*t+y*i,s}},rotate:{fn(r,e,t,i=new K(16)){const{hypot:s,sin:n,cos:a}=Math;let[h,l,c]=t,u=s(h,l,c);if(!u)return null;u!=1&&(u=1/u,h*=u,l*=u,c*=u);const p=n(e),f=a(e),m=1-f,[d,g,y,v,w,E,A,k,T,b,B,x]=r,M=h*m,S=l*m,P=c*m,F=h*M+f,R=l*M+c*p,D=c*M-l*p,_=h*S-c*p,j=l*S+f,X=c*S+h*p,N=h*P+l*p,ee=l*P-h*p,ue=c*P+f;return i[0]=d*F+w*R+T*D,i[1]=g*F+E*R+b*D,i[2]=y*F+A*R+B*D,i[3]=v*F+k*R+x*D,i[4]=d*_+w*j+T*X,i[5]=g*_+E*j+b*X,i[6]=y*_+A*j+B*X,i[7]=v*_+k*j+x*X,i[8]=d*N+w*ee+T*ue,i[9]=g*N+E*ee+b*ue,i[10]=y*N+A*ee+B*ue,i[11]=v*N+k*ee+x*ue,r!==i&&(i[12]=r[12],i[13]=r[13],i[14]=r[14],i[15]=r[15]),i}},lookAt:{fn(r,e,t,i=new K(16)){const{hypot:s}=Math;let[n,a,h]=r,[l,c,u]=t,[p,f,m]=e;if(n==p&&a==f&&h==m)return H.identity(i);let d,g,y,v,w,E,A=n-p,k=a-f,T=h-m,b=1/s(A,k,T);return A*=b,k*=b,T*=b,d=c*T-u*k,g=u*A-l*T,y=l*k-c*A,b=s(d,g,y),b?(b=1/b,d*=b,g*=b,y*=b):d=g=y=0,v=k*y-T*g,w=T*d-A*y,E=A*g-k*d,b=s(v,w,E),b?(b=1/b,v*=b,w*=b,E*=b):v=w=E=0,i[0]=d,i[1]=v,i[2]=A,i[3]=0,i[4]=g,i[5]=w,i[6]=k,i[7]=0,i[8]=y,i[9]=E,i[10]=T,i[11]=0,i[12]=-(d*n+g*a+y*h),i[13]=-(v*n+w*a+E*h),i[14]=-(A*n+k*a+T*h),i[15]=1,i}},fpsView:{fn(r,e,t,i=0,s=new K(16)){const{cos:n,sin:a}=Math;let[h,l,c]=r,u=n(e),p=a(e),f=n(t),m=a(t),d=n(-i),g=a(-i),y=f*d,v=f*g,w=-m,E=p*m*d-u*g,A=p*m*g+u*d,k=p*f,T=u*m*d+p*g,b=u*m*g-p*d,B=u*f;return s[0]=y,s[1]=E,s[2]=T,s[3]=0,s[4]=v,s[5]=A,s[6]=b,s[7]=0,s[8]=w,s[9]=k,s[10]=B,s[11]=0,s[12]=-(y*h+v*l+w*c),s[13]=-(E*h+A*l+k*c),s[14]=-(T*h+b*l+B*c),s[15]=1,s},argsLen:5},perspective:{fn(r,e,t,i,s=new K(16)){const n=1/Math.tan(r*Math.PI/360),a=1/(i-t);return s[0]=n/e,s[1]=s[2]=s[3]=0,s[4]=0,s[5]=n,s[6]=s[7]=0,s[8]=s[9]=0,s[10]=-(i+t)*a,s[11]=-1,s[12]=s[13]=0,s[14]=-2*i*t*a,s[15]=0,s}},ortho:{fn(r,e,t,i,s,n,a=new K(16)){const h=1/(r-e),l=1/(t-i),c=1/(s-n);return a[0]=-2*h,a[1]=a[2]=a[3]=0,a[4]=0,a[5]=-2*l,a[6]=a[7]=0,a[8]=a[9]=0,a[10]=2*c,a[11]=0,a[12]=(r+e)*h,a[13]=(i+t)*l,a[14]=(n+s)*c,a[15]=1,a}},transpose:{alias:["T"],fn(r,e=new K(16)){const[t,i,s,n,a,h,l,c,u,p,f,m,d,g,y,v]=r;return e[1]=a,e[2]=u,e[3]=d,e[4]=i,e[6]=p,e[7]=g,e[8]=s,e[9]=l,e[11]=y,e[12]=n,e[13]=c,e[14]=m,r!==e&&(e[0]=t,e[5]=h,e[10]=f,e[15]=v),e}},inverse:{alias:["inv"],fn([r,e,t,i,s,n,a,h,l,c,u,p,f,m,d,g],y=new K(16)){const v=r*n-e*s,w=r*a-t*s,E=r*h-i*s,A=e*a-t*n,k=e*h-i*n,T=t*h-i*a,b=l*m-c*f,B=l*d-u*f,x=l*g-p*f,M=c*d-u*m,S=c*g-p*m,P=u*g-p*d,F=v*P-w*S+E*M+A*x-k*B+T*b;if(F===0)return H.identity(y);const R=1/F;return y[0]=(n*P-a*S+h*M)*R,y[1]=(-e*P+t*S-i*M)*R,y[2]=(m*T-d*k+g*A)*R,y[3]=(-c*T+u*k-p*A)*R,y[4]=(-s*P+a*x-h*B)*R,y[5]=(r*P-t*x+i*B)*R,y[6]=(-f*T+d*E-g*w)*R,y[7]=(l*T-u*E+p*w)*R,y[8]=(s*S-n*x+h*b)*R,y[9]=(-r*S+e*x-i*b)*R,y[10]=(f*k-m*E+g*v)*R,y[11]=(-l*k+c*E-p*v)*R,y[12]=(-s*M+n*B-a*b)*R,y[13]=(r*M-e*B+t*b)*R,y[14]=(-f*A+m*w-d*v)*R,y[15]=(l*A-c*w+u*v)*R,y}}});let Y=window.Float32Array||Array;const I=ht("Vec3",()=>new Y(3),{getArrType:{fn:()=>Y},setArrType:{fn(r){Y=r}},create:{fn(r=0,e=0,t=0,i=new Y(3)){return i[0]=r,i[1]=e,i[2]=t,i},input:0,argsLen:4},copy:{alias:["copyTo","copy2","clone"],fn(r,e=new Y(3)){return r===e||(e[0]=r[0],e[1]=r[1],e[2]=r[2]),e},derived:{copyFrom:{alias:["set","="],fn:r=>r,input:2,output:1}}},length:{alias:["len","l"],fn(r){return Math.hypot(r[0],r[1],r[2])},argsLen:1,output:0},add:{alias:["+","plus"],fn(r,e,t=new Y(3)){return t[0]=r[0]+e[0],t[1]=r[1]+e[1],t[2]=r[2]+e[2],t}},subtract:{alias:["sub","-","minus"],fn(r,e,t=new Y(3)){return t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],t}},multiply:{alias:["mul"],fn(r,e,t=new Y(3)){return t[0]=r[0]*e[0],t[1]=r[1]*e[1],t[2]=r[2]*e[2],t}},cross:{alias:["x","×"],fn([r,e,t],[i,s,n],a=new Y(3)){return a[0]=e*n-t*s,a[1]=t*i-r*n,a[2]=r*s-e*i,a}},dot:{alias:[".","·"],fn(r,e){return r[0]*e[0]+r[1]*e[1]+r[2]*e[2]},argsLen:2,output:0},scale:{alias:["times"],fn(r,e,t=new Y(3)){return t[0]=r[0]*e,t[1]=r[1]*e,t[2]=r[2]*e,t}},scaleAndAdd:{fn(r,e,t,i=new Y(3)){return i[0]=r[0]+e[0]*t,i[1]=r[1]+e[1]*t,i[2]=r[2]+e[2]*t,i}},"*":{fn(r,e,t=new Y(3)){return typeof r=="number"||typeof r=="bigint"?I.scale(r,t):typeof e>"u"?I.multiply(r,t):I.scaleAndAdd(r,e,t)}},divide:{alias:["div","/","dividedBy"],fn(r,e,t=new Y(3)){return t[0]=r[0]/e[0],t[1]=r[1]/e[1],t[2]=r[2]/e[2],t}},normalize:{alias:["norm","unit"],fn([r,e,t],i=new Y(3)){const s=Math.hypot(r,e,t);return s?(i[0]=r/s,i[1]=e/s,i[2]=t/s):i[0]=i[1]=i[2]=0,i}},negate:{alias:["neg","negated"],fn(r,e=new Y(3)){return e[0]=-r[0],e[1]=-r[1],e[2]=-r[2],e}},rotateX:{fn(r,e,t=new Y(3)){const[i,s,n]=r,a=Math.sin(e),h=Math.cos(e);return t[0]=i,t[1]=s*h-n*a,t[2]=s*a+n*h,t}},rotateY:{fn(r,e,t=new Y(3)){const[i,s,n]=r,a=Math.sin(e),h=Math.cos(e);return t[0]=n*a+i*h,t[1]=s,t[2]=n*h-i*a,t}},rotateZ:{fn(r,e,t=new Y(3)){const[i,s,n]=r,a=Math.sin(e),h=Math.cos(e);return t[0]=i*h-s*a,t[1]=i*a+s*h,t[2]=n,t}},inverse:{alias:["inv","'"],fn([r,e,t],i=new Y(3)){return i[0]=r&&1/r,i[1]=e&&1/e,i[2]=t&&1/t,i}},exactEquals:{alias:["==="],fn(r,e){return r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2]},argsLen:2,output:0},equals:{alias:["=="],fn([r,e,t],[i,s,n]){const{abs:a,max:h}=Math;return a(r-i)<=le*h(1,a(r),a(i))&&a(e-s)<=le*h(1,a(e),a(s))&&a(t-n)<=le*h(1,a(t),a(n))},argsLen:2,output:0},transformMat4:{fn([r,e,t],i,s=new Y(3)){const n=i[3]*r+i[7]*e+i[11]*t+i[15]||1;return s[0]=(i[0]*r+i[4]*e+i[8]*t+i[12])/n,s[1]=(i[1]*r+i[5]*e+i[9]*t+i[13])/n,s[2]=(i[2]*r+i[6]*e+i[10]*t+i[14])/n,s}},moveToward:{alias:["move_toward"],fn(r,e,t,i=new Y(3)){const[s,n,a]=e,h=s-r[0],l=n-r[1],c=a-r[2],u=Math.hypot(h,l,c);return u<=t||u<=le?(i[0]=s,i[1]=n,i[2]=a):I.scaleAndAdd(r,[h,l,c],t/u,i),i}},lerpUnclamped:{fn(r,e,t,i=new Y(3)){const[s,n,a]=r,h=e[0]-s,l=e[1]-n,c=e[2]-a;return i[0]=s+h*t,i[1]=n+l*t,i[2]=a+c*t,i}},lerp:{fn(r,e,t,i=new Y(3)){return I.lerpUnclamped(r,e,Math.max(0,Math.min(1,t)),i)}}});window.vec3=I;let G=window.Float32Array||Array;const Z=ht("Vec2",()=>new G(2),{getArrType:{fn:()=>G},setArrType:{fn(r){G=r}},create:{fn(r=0,e=0,t=new G(2)){return t[0]=r,t[1]=e,t},input:0,argsLen:3},copy:{alias:["copyTo","copy2","clone"],fn(r,e=new G(2)){return r===e||(e[0]=r[0],e[1]=r[1]),e},derived:{copyFrom:{alias:["set","="],fn:r=>r,input:2,output:1}}},length:{alias:["len","l"],fn(r){return Math.hypot(r[0],r[1])},argsLen:1,output:0},add:{alias:["+","plus"],fn(r,e,t=new G(2)){return t[0]=r[0]+e[0],t[1]=r[1]+e[1],t}},subtract:{alias:["sub","-","minus"],fn(r,e,t=new G(2)){return t[0]=r[0]-e[0],t[1]=r[1]-e[1],t}},multiply:{alias:["mul"],fn(r,e,t=new G(2)){return t[0]=r[0]*e[0],t[1]=r[1]*e[1],t}},cross:{alias:["x","×"],fn(r,e){return r[0]*e[1]-r[1]*e[0]},argsLen:2,output:0},dot:{alias:[".","·"],fn(r,e){return r[0]*e[0]+r[1]*e[1]},argsLen:2,output:0},scale:{alias:["times"],fn(r,e,t=new G(2)){return t[0]=r[0]*e,t[1]=r[1]*e,t}},scaleAndAdd:{fn(r,e,t,i=new G(2)){return i[0]=r[0]+e[0]*t,i[1]=r[1]+e[1]*t,i}},"*":{fn(r,e,t=new G(2)){return typeof r=="number"||typeof r=="bigint"?Z.scale(r,t):typeof e>"u"?Z.multiply(r,t):Z.scaleAndAdd(r,e,t)}},divide:{alias:["div","/","dividedBy"],fn(r,e,t=new G(2)){return t[0]=r[0]/e[0],t[1]=r[1]/e[1],t}},normalize:{alias:["norm","unit"],fn([r,e],t=new G(2)){const i=Math.hypot(r,e);return i?(t[0]=r/i,t[1]=e/i):t[0]=t[1]=0,t}},negate:{alias:["neg","negated"],fn(r,e=new G(2)){return e[0]=-r[0],e[1]=-r[1],e}},rotateOrigin:{alias:["rotateO"],fn([r,e],t,i=new G(2)){const s=Math.sin(t),n=Math.cos(t);return i[0]=r*n-e*s,i[1]=r*s+e*n,i}},roatePoint:{alias:["rotateP"],fn(r,[e,t],i,s=new G(2)){const n=Math.sin(i),a=Math.cos(i),h=r[0]-e,l=r[1]-t;return s[0]=h*a-l*n+e,s[1]=h*n+l*a+t,s}},angle:{fn([r,e],[t,i]){const{atan2:s}=Math;return s(i,t)-s(e,r)},argsLen:2,output:0},inverse:{fn([r,e],t=new G(2)){return t[0]=r&&1/r,t[1]=e&&1/e,t}},exactEquals:{fn(r,e){return r[0]===e[0]&&r[1]===e[1]},argsLen:2,output:0},equals:{fn([r,e],[t,i]){const{abs:s,max:n}=Math;return s(r-t)<=le*n(1,s(r),s(t))&&s(e-i)<=le*n(1,s(e),s(i))},argsLen:2,output:0},moveToward:{alias:["move_toward"],fn(r,e,t,i=new G(2)){const[s,n]=e,a=s-r[0],h=n-r[1],l=Math.hypot(a,h);return l<=t||l<=le?(i[0]=s,i[1]=n):Z.scaleAndAdd(r,[a,h],t/l,i),i}},lerpUnclamped:{fn(r,e,t,i=new G(2)){const[s,n]=r,a=e[0]-s,h=e[1]-n;return i[0]=s+a*t,i[1]=n+h*t,i}},lerp:{fn(r,e,t,i=new G(2)){return Z.lerpUnclamped(r,e,Math.max(0,Math.min(1,t)),i)}}});window.vec2=Z;function ft(r,e,t){const i=r.createShader(e);if(r.shaderSource(i,t),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS))throw"error compile "+(e===r.VERTEX_SHADER?"vertex":"fragment")+" shader: "+r.getShaderInfoLog(i);return i}function ii(r,e,t){const i=r.createProgram();if(r.attachShader(i,e),r.attachShader(i,t),r.linkProgram(i),!r.getProgramParameter(i,r.LINK_STATUS))throw"error link program: "+r.getProgramInfoLog(i);return i}class si{constructor(e,t,i){this.ctx=this.gl=e;let s=ft(e,e.VERTEX_SHADER,t),n=ft(e,e.FRAGMENT_SHADER,i);this.shaders={vs:s,fs:n};let a=this.prog=this.program=ii(e,s,n);const h=(l,c=l===e.ACTIVE_ATTRIBUTES?"Attrib":"Uniform")=>[...Array(e.getProgramParameter(a,l))].map((u,p)=>{const{size:f,type:m,name:d}=e["getActive"+c](a,p),g=e[`get${c}Location`](a,d);return{size:f,type:m,name:d.split("[")[0],loc:g}}).reduce((u,{name:p,size:f,type:m,loc:d})=>(u[p]={name:p,size:f,type:m,loc:d},u),{});this.vars={atts:h(e.ACTIVE_ATTRIBUTES),unis:h(e.ACTIVE_UNIFORMS)}}use(){return this.ctx.useProgram(this.prog),this}getAtt(e){return this.vars.atts[e].loc}getUni(e){return this.vars.unis[e].loc}setAtt(e,t,i=void 0,s=this.ctx.FLOAT,n=!1,a=0,h=0){const l=this.ctx,c=this.vars.atts[e];if(!c)throw"Cannot get attribute "+e;if(i===void 0)switch(c.type){case l.FLOAT:i=1;break;case l.FLOAT_VEC2:case l.FLOAT_MAT2:i=2;break;case l.FLOAT_VEC3:case l.FLOAT_MAT3:i=3;break;case l.FLOAT_VEC4:case l.FLOAT_MAT4:i=4;break;default:throw console.error("Don't know gl type",c.type,"for attribute",c.name),"Don't know attribute type"}let u=t.type||l.ARRAY_BUFFER;return l.bindBuffer(u,t),l.enableVertexAttribArray(c.loc),l.vertexAttribPointer(c.loc,i,s,n,a,h),l.bindBuffer(u,null),this}setUni(e,t){const i=this.ctx,s=this.vars.unis[e];switch(s.type){case i.FLOAT_MAT4:i.uniformMatrix4fv(s.loc,!1,t);break;case i.FLOAT_MAT3:i.uniformMatrix3fv(s.loc,!1,t);break;case i.FLOAT_MAT2:i.uniformMatrix2fv(s.loc,!1,t);break;case i.FLOAT:i.uniform1f(s.loc,t);break;case i.INT:case i.SAMPLER_CUBE:case i.SAMPLER_2D:case i.SAMPLER_2D_ARRAY:i.uniform1i(s.loc,t);break;case i.FLOAT_VEC2:i.uniform2fv(s.loc,t);break;case i.FLOAT_VEC3:i.uniform3fv(s.loc,t);break;case i.FLOAT_VEC4:i.uniform4fv(s.loc,t);break;case i.INT_VEC2:i.uniform2iv(s.loc,t);break;case i.INT_VEC3:i.uniform3iv(s.loc,t);break;case i.INT_VEC4:i.uniform4iv(s.loc,t);break;default:throw console.warn("Don't know gl type",s.type,"for uniform",s.name),"Don't know uniform type"}return this}bindTex(e,t,i=t.type||ctx.TEXTURE_2D,s=0){const n=this.ctx;return n.activeTexture(n.TEXTURE0+s),n.bindTexture(i,t),this.setUni(e,s)}dispose(){const{ctx:e}=this;e.deleteShader(this.shaders.vs),e.deleteShader(this.shaders.fs),e.deleteProgram(this.program)}}class ct{constructor(e){let t=this.gl=this.ctx=e.getContext("webgl2")||e.getContext("webgl")||e.getContext("experimental-webgl");if(!t)throw"Cannot get the WebGL context";this.isWebGL2="isSupportWebGL2"in window?window.isSupportWebGL2:It(t),this.prgCache={},this.texCache={},this.bufferCache=new Set,this.camera=[],this.frame=this.frame.bind(this),this.timer=null,this.lastFrameTime=window.performance.now()}get dpr(){return this._dpr||window.devicePixelRatio}set dpr(e){this.dpr!==e&&(this._dpr=e)}get aspectRatio(){return this.ctx.canvas.width/this.ctx.canvas.height}addCamera(e){return this.camera.push(e),this}createProgram(e,t,i){return this.prgCache[e]=new si(this.ctx,t,i)}getProgram(e){return this.prgCache[e]}delProgram(e){var t;(t=this.prgCache[e])==null||t.dispose(),delete this.prgCache[e]}frame(e=this.lastFrameTime){this.timer=window.requestAnimationFrame(this.frame),this.onRender&&this.onRender(e,e-this.lastFrameTime),this.lastFrameTime=e}play(){this.timer===null&&(this.lastFrameTime=window.performance.now(),this.frame())}stop(){this.timer!==null&&(window.cancelAnimationFrame(this.timer),this.timer=null)}isPlaying(){return this.timer!==null}setSize(e,t,i=this.dpr){const s=this.ctx.canvas;return this.dpr=i,e=e*i|0,t=t*i|0,s.width=e,s.height=t,this.ctx.viewport(0,0,e,t),this.camera.forEach(n=>n.setAspectRatio(e/t)),{w:e,h:t}}fitScreen(e=1,t=1){return this.setSize(window.innerWidth*e,window.innerHeight*t)}createIbo(e,t=this.ctx.STATIC_DRAW){return this.createBo(e,this.ctx.ELEMENT_ARRAY_BUFFER,t)}createVbo(e,t=this.ctx.STATIC_DRAW){return this.createBo(e,this.ctx.ARRAY_BUFFER,t)}createBo(e,t,i=this.ctx.STATIC_DRAW){return this.bindBoData(this.ctx.createBuffer(),e,{boType:t,drawType:i})}bindBoData(e,t,{boType:i=e.type,drawType:s=this.ctx.STATIC_DRAW}={}){const n=this.ctx;return t.buffer instanceof ArrayBuffer||(i===n.ELEMENT_ARRAY_BUFFER?t=new Int16Array(t):i===n.ARRAY_BUFFER&&(t=new Float32Array(t))),e.length=t.length,e.type=i,n.bindBuffer(i,e),n.bufferData(i,t,s),n.bindBuffer(i,null),this.bufferCache.has(e)||this.bufferCache.add(e),e}delBo(e){return this.bufferCache.has(e)?(this.ctx.deleteBuffer(e),this.bufferCache.delete(e)):!1}_getImageName(e){let t=e.outerHTML.match(/src="([^"]*)"/);return t?t[1]:String(Math.random())}createTexture(e,t=this._getImageName(e),i=!1){const{ctx:s}=this,n=s.createTexture();if(i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),s.bindTexture(s.TEXTURE_2D,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,e.mipmap&&e.mipmap[0]?e.mipmap[0]:e),e.mipmap){s.generateMipmap(s.TEXTURE_2D),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST_MIPMAP_LINEAR);for(let a=1;a<e.mipmap.length;++a)s.texImage2D(s.TEXTURE_2D,a,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,e.mipmap[a])}return s.bindTexture(s.TEXTURE_2D,null),i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1),this.texCache[t]=n,n.name=t,n.type=s.TEXTURE_2D,n}createTextureArray(e,{singleW:t=e.texture4array&&e.texture4array.singleW,singleH:i=e.texture4array&&e.texture4array.singleH,altesCount:s=e.texture4array&&e.texture4array.altesCount,name:n=this._getImageName(e),doYFlip:a=!1,useMips:h=!0}={}){if(!window.isSupportWebGL2||!this.isWebGL2)throw"not support webgl2";e.texture4array&&(e=e.texture4array);const{ctx:l}=this,c=l.createTexture();if(a&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!0),l.bindTexture(l.TEXTURE_2D_ARRAY,c),l.texParameteri(l.TEXTURE_2D_ARRAY,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D_ARRAY,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D_ARRAY,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D_ARRAY,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),t>=l.getParameter(l.MAX_TEXTURE_SIZE))throw"width out of range";if(i>=l.getParameter(l.MAX_TEXTURE_SIZE))throw"height out of range";if(s>=l.getParameter(l.MAX_ARRAY_TEXTURE_LAYERS))throw"depth out of range";if(Array.isArray(e)){l.texImage3D(l.TEXTURE_2D_ARRAY,0,l.RGBA,t,i,s,0,l.RGBA,l.UNSIGNED_BYTE,null);for(let u=0;u<e.length;++u)l.texSubImage3D(l.TEXTURE_2D_ARRAY,0,0,0,u,t,i,1,l.RGBA,l.UNSIGNED_BYTE,e[u])}else l.texImage3D(l.TEXTURE_2D_ARRAY,0,l.RGBA,t,i,s,0,l.RGBA,l.UNSIGNED_BYTE,e);return h&&(l.generateMipmap(l.TEXTURE_2D_ARRAY),l.texParameteri(l.TEXTURE_2D_ARRAY,l.TEXTURE_MIN_FILTER,l.NEAREST_MIPMAP_LINEAR)),l.bindTexture(l.TEXTURE_2D_ARRAY,null),a&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!1),this.texCache[n]=c,c.name=n,c.type=l.TEXTURE_2D_ARRAY,c}createCubemapsTexture(e,t=Math.random(),i=!1){const{ctx:s}=this,n=s.createTexture();i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),s.bindTexture(s.TEXTURE_CUBE_MAP,n),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);for(let a=0;a<6;++a)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,e[a]);return s.generateMipmap(s.TEXTURE_CUBE_MAP),s.bindTexture(s.TEXTURE_CUBE_MAP,null),i&&s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),this.texCache[t]=n,n.name=t,n.type=s.TEXTURE_CUBE_MAP,n}getTexture(e){return this.texCache[e]}getOrCreateTexture(e,t=e instanceof Image&&this._getImageName(e),i=!1){let s=this.getTexture(t);if(s)return s;if(Array.isArray(e))return this.createCubemapsTexture(e,t,i);if(e.texture4array)try{return this.createTextureArray(e,{name:t,doYFlip:i})}catch(n){console.warn(n),window.isSupportWebGL2=this.isWebGL2=!1}return this.createTexture(e,t,i)}dispose(){this.stop();const{ctx:e}=this;this.bufferCache.forEach(t=>e.deleteBuffer(t)),this.bufferCache.clear(),Object.values(this.texCache).forEach(t=>e.deleteTexture(t)),this.texCache={},Object.values(this.prgCache).forEach(t=>t.dispose())}}class Q{static get projectionType(){return{perspective:"perspective",ortho:"orthographic"}}static get viewType(){return{fps:"fpsView",lookAt:"lookAt"}}constructor(e,{projectionType:t=Q.projectionType.perspective,viewType:i=Q.viewType.fps,fovy:s=90,near:n=.1,far:a=256,left:h=-1,right:l=1,bottom:c=-1,top:u=1,position:p=[0,0,3],pitch:f=0,yaw:m=0,rollZ:d=0,target:g=[0,0,0],up:y=[0,1,0],entity:v=null}={}){switch(this.projectionType=t,this.viewType=i,this.aspectRatio=e,this.fovy=this.nowFovy=s,this.near=n,this.far=a,this.left=h,this.right=l,this.bottom=c,this.top=u,this.position=I.create(...p),this.pitch=f,this.yaw=m,this.rollZ=d,this.target=g,this.up=y,i){case Q.viewType.fps:this.vM=H.fpsView(this.position,f,m,d);break;case Q.viewType.lookAt:this.vM=H.lookAt(this.position,g,y);break;default:throw"Unrecognized view type"}switch(t){case Q.projectionType.perspective:this.pM=H.perspective(this.fovy,this.aspectRatio,this.near,this.far);break;case Q.projectionType.ortho:this.pM=H.ortho(this.left,this.right,this.bottom,this.top,this.near,this.far);break;default:throw"Unrecognized projection type"}this.pvM=H.multiply(this.pM,this.vM),this.pChange=this.vChange=!1,this.bindEntity(v)}setPos(e){return this.position=I.create(...e),this.vChange=!0,this}setPitch(e){return this.pitch=e,this.vChange=!0,this}setYaw(e){return this.yaw=e,this.vChange=!0,this}setRollZ(e){return this.rollZ=e,this.vChange=!0,this}setTarget(e){return this.target=e,this.vChange=!0,this}setUp(e){return this.up=e,this.vChange=!0,this}setFovy(e){return e==this.fovy?this:(this.fovy=this.nowFovy=e,this.pChange=!0,this)}setNear(e){return this.near=e,this.pChange=!0,this}setFar(e){return this.far=e,this.pChange=!0,this}setAspectRatio(e){return this.aspectRatio=e,this.pChange=!0,this}setLeft(e){return this.left=e,this.pChange=!0,this}setRight(e){return this.right=e,this.pChange=!0,this}setBottom(e){return this.bottom=e,this.pChange=!0,this}setTop(e){return this.top=e,this.pChange=!0,this}_linearGradient(e,t,i,s,n){return n=Math.max(0,Math.min((n-e)/(t-e),1)),i>s?i-(i-s)*n:i+(s-i)*n}_powerGradient(e,t,i,s,n){return n=Math.max(0,Math.min((n-e)/(t-e),1)),i>s?s+(i-s)*(-n+1)**2:i+(s-i)*n**.5}changeFovyWithAnimation(e=0,t=250){if(t==0)return this.setFovy(this.fovy+e);if(this.fovy+e===this.endFovy)return this;let i=this.nowTime=new Date().getTime();return"beginFovy"in this||(this.endFovy=this.nowFovy=this.fovy,this.fovyAnimationEndTime=i),this.fovyAnimationEndTime<=i?(this.fovyAnimationBeginTime=i,this.fovyAnimationEndTime=i+t):(this.fovyAnimationEndTime=i+(i-this.fovyAnimationBeginTime),this.fovyAnimationBeginTime=this.fovyAnimationEndTime-t),this.beginFovy=this.endFovy,this.endFovy=this.fovy+e,this}get projection(){return this.pChange?(this.pChange=!1,this.projectionType===Q.projectionType.perspective?H.perspective(this.nowFovy,this.aspectRatio,this.near,this.far,this.pM):H.ortho(this.left,this.right,this.bottom,this.top,this.near,this.far,this.pM)):this.pM}get view(){if(this.entity){let e=this.entity,t=e.getEyePosition();return this.pitch==e.pitch&&this.yaw==e.yaw&&I.exactEquals(t,e.position)?this.vM:(I.create(...t,this.position),this.pitch=e.pitch,this.yaw=e.yaw,H.fpsView(this.position,this.pitch,this.yaw,this.rollZ,this.vM))}return this.vChange?(this.vChange=!1,this.viewType===Q.viewType.fps?H.fpsView(this.position,this.pitch,this.yaw,this.rollZ,this.vM):H.lookAt(this.position,this.target,this.up,this.vM)):this.vM}get projview(){let e=new Date().getTime();return this.nowFovy!=this.endFovy&&e-this.nowTime>16&&(this.nowTime=e,this.pChange=!0,this.nowFovy=this._powerGradient(this.fovyAnimationBeginTime,this.fovyAnimationEndTime,this.beginFovy,this.endFovy,e)),this.entity||this.pChange||this.vChange?H.multiply(this.projection,this.view,this.pvM):this.pvM}bindEntity(e=null){if(e===this.entity)return this;const t=this.entity;return this.entity=e,t&&t.setCamera(null),e&&e.setCamera(this),this}}let gt={vert:`#version 300 es
        precision highp int;
        precision highp float;
        in vec3 position;
        in vec4 color;
        in vec3 textureCoord;
        // uniform mat4 mMatrix;
        // uniform mat4 vMatrix;
        // uniform mat4 pMatrix;
        uniform mat4 mvMatrix;
        uniform mat4 mvpMatrix;
        out vec4 vColor;
        out vec3 vTextureCoord;
        out vec3 vPos;
        void main(void) {
            vColor = color;
            vTextureCoord  = textureCoord;
            vec4 pos = vec4(position, 1.0);
            vPos = (mvMatrix * pos).xyz;
            gl_Position = mvpMatrix * pos;
        }`,frag:`#version 300 es
        precision highp int;
        precision highp float;
        precision highp sampler2DArray;
        uniform sampler2DArray blockTex;
        uniform vec4 fogColor;
        uniform float fogNear;
        uniform float fogFar;
        in vec4 vColor;
        in vec3 vTextureCoord;
        in vec3 vPos;
        out vec4 fragmentColor;
        void main(void){
            vec4 smpColor = texture(blockTex, vTextureCoord);
            if (smpColor.a <= 0.3) discard;
            float fogDistance = length(vPos);
            float fogAmount = smoothstep(fogNear, fogFar, fogDistance);
            fragmentColor  = mix(vColor * smpColor, fogColor, fogAmount);
        }`},mt={vert:`
        attribute vec3 position;
        attribute vec4 color;
        attribute vec3 textureCoord;
        // uniform mat4 mMatrix;
        // uniform mat4 vMatrix;
        // uniform mat4 pMatrix;
        uniform mat4 mvMatrix;
        uniform mat4 mvpMatrix;
        varying vec4 vColor;
        varying vec3 vTextureCoord;
        varying vec3 vPos;
        void main(void) {
            vColor = color;
            vTextureCoord  = textureCoord;
            vec4 pos = vec4(position, 1.0);
            vPos = (mvMatrix * pos).xyz;
            gl_Position = mvpMatrix * pos;
        }`,frag:`
        #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
        #else
        precision mediump float;
        #endif
        uniform sampler2D blockTex;
        uniform vec4 fogColor;
        uniform float fogNear;
        uniform float fogFar;
        varying vec4 vColor;
        varying vec3 vTextureCoord;
        varying vec3 vPos;
        void main(void){
            vec4 smpColor = texture2D(blockTex, vTextureCoord.xy);
            if (smpColor.a <= 0.3) discard;
            float fogDistance = length(vPos);
            float fogAmount = smoothstep(fogNear, fogFar, fogDistance);
            gl_FragColor  = mix(vColor * smpColor, fogColor, fogAmount);
        }`},yt={vert:`#version 300 es
        precision highp int;
        precision highp float;
        in vec3 position;
        in vec4 color;
        in vec3 textureCoord;
        uniform mat4 mMatrix;
        uniform mat4 vMatrix;
        uniform mat4 pMatrix;
        out vec4 vColor;
        out vec3 vTextureCoord;
        out vec3 vPos;
        void main(void) {
            vColor = color;
            mat4 mvMatrix = vMatrix * mMatrix;
            vTextureCoord  = textureCoord;
            vec4 pos = vec4(position, 1.0);
            vPos = (mvMatrix * pos).xyz;
            gl_Position = pMatrix * mvMatrix * pos;
        }`,frag:`#version 300 es
        precision highp int;
        precision highp float;
        precision highp sampler2DArray;
        uniform sampler2DArray blockTex;
        uniform vec4 fogColor;
        uniform float fogNear;
        uniform float fogFar;
        in vec4 vColor;
        in vec3 vTextureCoord;
        in vec3 vPos;
        out vec4 fragmentColor;
        void main(void){
            vec4 smpColor = texture(blockTex, vTextureCoord);
            if (smpColor.a <= 0.3) discard;
            float fogDistance = length(vPos);
            float fogAmount = smoothstep(fogNear, fogFar, fogDistance);
            fragmentColor  = mix(vColor * smpColor, fogColor, fogAmount);
        }`},vt={vert:`
        attribute vec3 pos;
        attribute vec4 col;
        uniform   mat4 mvp;
        varying   vec4 vCol;
        void main(void) {
            vCol = col;
            gl_Position = mvp * vec4(pos, 1.0);
        }`,frag:`
        precision mediump float;
        varying vec4 vCol;
        void main(void) {
            gl_FragColor = vCol;
        }`},wt={vert:`#version 300 es
        precision highp int;
        precision highp float;
        in vec3 position;
        in vec4 normal;
        in vec4 color;
        in vec3 textureCoord;
        uniform mat4 mvpMatrix;
        uniform mat4 normalMatrix;
        uniform vec3 diffuseLightDirection;     // need normalize
        uniform vec3 diffuseLightColor;
        uniform vec3 ambientLightColor;
        out   vec4 vColor;
        out   vec3 vTextureCoord;
        void main(void) {
            gl_Position    = mvpMatrix * vec4(position, 1.0);
            vTextureCoord  = textureCoord;
            vec4 nor = normalMatrix * normal;
            vec3 nor2 = normalize(nor.xyz);
            // normal dot light direction
            float nDotL = max(dot(diffuseLightDirection, nor2), 0.0);
            vec3 diffuse = diffuseLightColor * color.rgb * nDotL;
            vec3 ambient = ambientLightColor * color.rgb;
            vColor = vec4(diffuse + ambient, color.a);
        }`,frag:`#version 300 es
        precision highp int;
        precision highp float;
        precision highp sampler2DArray;
        uniform sampler2DArray blockTex;
        in vec4      vColor;
        in vec3      vTextureCoord;
        out vec4 fragmentColor;

        void main(void){
            vec4 smpColor = texture(blockTex, vTextureCoord);
            if (smpColor.a == 0.0) discard;
            fragmentColor  = vColor * smpColor;
        }`},Tt={vert:`
        attribute vec3 position;
        attribute vec4 normal;
        attribute vec4 color;
        attribute vec3 textureCoord;
        uniform mat4 mvpMatrix;
        uniform mat4 normalMatrix;
        uniform vec3 diffuseLightDirection;     // need normalize
        uniform vec3 diffuseLightColor;
        uniform vec3 ambientLightColor;
        varying   vec4 vColor;
        varying   vec3 vTextureCoord;
        void main(void) {
            gl_Position    = mvpMatrix * vec4(position, 1.0);
            vTextureCoord  = textureCoord;
            vec4 nor = normalMatrix * normal;
            vec3 nor2 = normalize(nor.xyz);
            // normal dot light direction
            float nDotL = max(dot(diffuseLightDirection, nor2), 0.0);
            vec3 diffuse = diffuseLightColor * color.rgb * nDotL;
            vec3 ambient = ambientLightColor * color.rgb;
            vColor = vec4(diffuse + ambient, color.a);
        }`,frag:`
        #ifdef GL_FRAGMENT_PRECISION_HIGH
        precision highp float;
        #else
        precision mediump float;
        #endif
        uniform sampler2D blockTex;
        varying vec4      vColor;
        varying vec3      vTextureCoord;

        void main(void){
            vec4 smpColor = texture2D(blockTex, vTextureCoord.xy);
            if (smpColor.a == 0.0) discard;
            gl_FragColor  = vColor * smpColor;
        }`},bt={vert:`
        attribute vec3 aPosition;
        uniform   mat4 uMvpMatrix;
        varying   vec3 vNoraml;
        void main(void){
            vNoraml = normalize(aPosition);
            gl_Position = uMvpMatrix * vec4(aPosition, 1.0);
        }`,frag:`
        precision lowp float;
        uniform samplerCube uTexture;
        varying vec3 vNoraml;
        void main(void){
            gl_FragColor = textureCube(uTexture, vNoraml);
        }`},Dt=null;tt("welcomePage/textures").then(r=>Dt=r);class ni extends ct{constructor(e){super(e),this.fitScreen(),new ResizeObserver(async a=>{await new Promise(h=>setTimeout(h,0)),this.fitScreen()}).observe(e);let t=[-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1],i=(a=>{let h=[0,1,2,0,2,3],l=[];for(let c=0,u=0;c<=a;u=c++*4)l.push(...h.map(p=>p+u));return l})(t.length/12);this.bos={ver:this.createVbo(t),ele:this.createIbo(i)},this.prg=this.createProgram("welcomePage",bt.vert,bt.frag).use().bindTex("uTexture",this.createCubemapsTexture(Dt,"welcomePage/textures")).setAtt("aPosition",this.bos.ver);const{ctx:s}=this;s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,s.LINEAR);let n=this.mainCamera=new Q(this.aspectRatio,{viewType:Q.viewType.lookAt,fovy:120,position:[0,0,0],lookAt:[-1,0,0],up:[0,1,0],far:10});this.addCamera(n),this.mM=H.identity(),this.mvpM=H.identity()}get vpM(){return this.mainCamera.projview}onRender(){const{ctx:e,prg:t,mM:i,vpM:s,mvpM:n,bos:a}=this;H.rotate(i,_t(1/70),[0,1,0],i),H.multiply(s,i,n),t.use().setUni("uMvpMatrix",n),e.clear(e.COLOR_BUFFER_BIT),e.bindBuffer(a.ele.type,a.ele),e.drawElements(e.TRIANGLES,a.ele.length,e.UNSIGNED_SHORT,0),e.flush()}}class ri extends re{constructor(){super();q(this,"updateBlur",(t="homepageBlur",i=U.homepageBlur)=>{t==="homepageBlur"&&this.bgCanvas.style.setProperty("--blur",i)});this.bgCanvas=this.shadowRoot.getElementById("background-canvas"),this.renderer=null}static get outdegree(){return["select-world","how-to-play","setting"]}onConnected(){this.renderer=new ni(this.bgCanvas),this.renderer.play(),U.addEventListener("changedValue",this.updateBlur),this.updateBlur()}onDisconnected(){this.renderer.dispose(),this.renderer=null,U.removeEventListener("changedValue",this.updateBlur)}onTransitionedFromThis(t){switch(t){case"select-world":case"how-to-play":case"setting":{this.renderer.stop();break}}}onTransitionedToThis(){this.renderer&&this.renderer.play()}onHistoryBack(){window.dispatchEvent(new Event("exit"))}onTransitioned(t,i,s,n,a,...h){i=="play"&&this.close()}}ri.asyncLoadAndDefine();class oi extends re{constructor(){super();q(this,"onBtnSelectClick",()=>{O.openPageByID("play",{storageId:this.selectedWordStorageId})});q(this,"onBtnDelClick",()=>{const t=JSON.parse(localStorage.getItem("worlds")||"{}");delete t[this.selectedWordStorageId],localStorage.setItem("worlds",JSON.stringify(t)),this.refreshList()});this.worldList=this.shadowRoot.getElementById("world-list"),this.btnSelect=this.shadowRoot.getElementById("btn-select"),this.btnDel=this.shadowRoot.getElementById("btn-del"),this.selectedWordStorageId=null,this.btnSelect.addEventListener("click",this.onBtnSelectClick),this.btnDel.addEventListener("click",this.onBtnDelClick)}static get outdegree(){return["welcome","play","create-new-world"]}refreshList(){this.selectedWordStorageId=null,this.btnSelect.disabled=!0,this.btnDel.disabled=!0;const t=i=>new Date(i).toLocaleString();this.worldList.innerHTML=Object.entries(JSON.parse(localStorage.getItem("worlds")||"{}")).sort((i,s)=>s[1].modifyAt-i[1].modifyAt).reduce((i,[s,n])=>i+`
                <li>
                    <span class="world-name">${n.name}</span>
                    <span class="create-at">Created - ${t(n.createAt)}</span>
                    <span class="modify-at">Modified - ${t(n.modifyAt)}</span>
                    <span class="world-mode">${n.type}</span>
                    <span class="storageId">${s}</span>
                </li>
            `,""),this.worldList.querySelectorAll("li").forEach(i=>i.onclick=()=>this.onLiClick(i))}onConnected(){this.refreshList()}onLiClick(t){var i;this.selectedWordStorageId=t.querySelector(".storageId").innerHTML,(i=this.worldList.querySelector("li.selected"))==null||i.classList.remove("selected"),t.classList.add("selected"),this.btnSelect.disabled=!1,this.btnDel.disabled=!1}onHistoryBack(){this.close()}onTransitioned(t,i,s,n,a,...h){i=="play"&&this.close()}}oi.asyncLoadAndDefine();class ai extends re{static get outdegree(){return["welcome"]}onHistoryBack(){this.close()}}ai.asyncLoadAndDefine();class li extends re{constructor(){super();q(this,"homepageBlur",this.shadowRoot.getElementById("homepage-blur"));q(this,"fov",this.shadowRoot.getElementById("fov"));q(this,"mousemoveSensitivity",this.shadowRoot.getElementById("mouse-sensitivity"));q(this,"shadeBtn",this.shadowRoot.getElementById("shade-btn"));q(this,"debugOutputBtn",this.shadowRoot.getElementById("debug-output-btn"));for(let n of["fov","mousemoveSensitivity","homepageBlur"]){const a=this[n].nextElementSibling;this[n].setAttribute("value",U[n]),this[n].setAttribute("min",U[n+"Min"]),this[n].setAttribute("max",U[n+"Max"]),this[n].addEventListener("valueChange",({detail:h})=>{U[n]=+h,h=U[n],this[n].setAttribute("value",h),a.disabled=h===U[n+"Default"],n==="homepageBlur"&&this[n].setAttribute("progress",h.toFixed(1))}),a.addEventListener("click",()=>{const h=U[n+"Default"];this[n].setAttribute("value",h),a.disabled=!0,U[n]=h,n==="homepageBlur"&&this[n].setAttribute("progress",h.toFixed(1))}),a.toggleAttribute("disabled",U[n]===U[n+"Default"]),n==="homepageBlur"&&this[n].setAttribute("progress",U[n].toFixed(1))}let t=this.shadowRoot.getElementById("shade-echo");t.innerHTML=U.shade?"ON":"OFF",this.shadeBtn.addEventListener("click",()=>{U.shade=!U.shade,t.innerHTML=U.shade?"ON":"OFF"});let i=this.shadowRoot.getElementById("debug-output-echo");i.innerHTML=U.showDebugOutput?"ON":"OFF",this.debugOutputBtn.addEventListener("click",()=>{U.showDebugOutput=!U.showDebugOutput,i.innerHTML=U.showDebugOutput?"ON":"OFF"});const s=O.getPageByID("welcome");if(this.shadowRoot.querySelector(".homepage-blur-group").style.display=s?null:"none",s){this.homepageBlur.addEventListener("pointerdown",n=>{var u;const a=this.homepageBlur.offsetLeft,h=this.homepageBlur.offsetTop,l=this.homepageBlur.offsetWidth,c=this.homepageBlur.offsetHeight;this.style.clipPath=`polygon(${a}px ${h}px, ${a+l}px ${h}px, ${a+l}px ${h+c}px, ${a}px ${h+c}px)`,(u=s.renderer)==null||u.play()});for(let n of"pointerup,pointercancel,pointerout".split(","))this.addEventListener(n,()=>{var a;this.style.clipPath=null,(a=s.renderer)==null||a.stop()})}if(O.getPageByID("play")){const n=O.getPageByID("pause");this.fov.addEventListener("pointerdown",a=>{const h=this.fov.offsetLeft,l=this.fov.offsetTop,c=this.fov.offsetWidth,u=this.fov.offsetHeight;this.style.clipPath=`polygon(${h}px ${l}px, ${h+c}px ${l}px, ${h+c}px ${l+u}px, ${h}px ${l+u}px)`,n&&(n.style.display="none")});for(let a of"pointerup,pointercancel,pointerout".split(","))this.addEventListener(a,()=>{this.style.clipPath=null,n&&(n.style.display=null)})}}static get outdegree(){return["welcome","pause"]}onHistoryBack(){this.close()}}li.asyncLoadAndDefine();class ge{constructor(e=0,t=0){return this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),e>0&&t>0&&this.setSize(e,t),this.wrapper=new Proxy(this,{get(i,s){if(s in i)return i[s];if(s in i.canvas)return typeof i.canvas[s]=="function"?i.canvas[s].bind(i.canvas):i.canvas[s];if(s in i.ctx)return typeof i.ctx[s]=="function"?i.ctx[s].bind(i.ctx):i.ctx[s]},set(i,s,n){return s in i&&(i[s]=n),s in i.canvas&&(i.canvas[s]=n),s in i.ctx&&(i.ctx[s]=n),!0}})}setSize(e,t,i=!1,s=2){return this.canvas.width=e,this.canvas.height=t,this.setImgSmoothingEnabled(i),i&&this.setImgSmoothingQuality(s),this.wrapper}setImgSmoothingEnabled(e){return this.ctx.mozImageSmoothingEnabled=e,this.ctx.webkitImageSmoothingEnabled=e,this.ctx.msImageSmoothingEnabled=e,this.ctx.imageSmoothingEnabled=e,this.ctx.oImageSmoothingEnabled=e,this.wrapper}setImgSmoothingQuality(e=2){return this.ctx.imageSmoothingQuality=["low","medium","high"][e],this.wrapper}toImage(e=function(){},t=function(){}){let i=new Image(this.canvas.width,this.canvas.height);return i.onload=e,i.onerror=t,i.src=this.canvas.toDataURL(),i}clear(){return this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.wrapper}cropAndZoom(e,t,i,s,n,a=1,{finalZoom:h=1,canvasW:l=s*a*h,canvasH:c=n*a*h}={}){return t*=a,i*=a,s*=a,n*=a,this.setSize(l,c),this.ctx.drawImage(e,t,i,s,n,0,0,l,c),this.wrapper}darken(e=.5){const{canvas:{width:t,height:i},ctx:s}=this;return s.globalCompositeOperation="source-atop",s.fillStyle=`rgba(0, 0, 0, ${e})`,s.fillRect(0,0,t,i),s.globalCompositeOperation="source-over",this.wrapper}}function hi(r,e=1,t=[32,16]){let i=new ge,s=r.width,n=r.height,a=[],[h,l]=t,c=s/h,u=n/l,p=c/2,f=u/2;s*=4,n*=4;for(let m=0;s>h&&n>l&&(!e||m<e);++m){s=s>>>1||s,n=n>>>1||n,i.setSize(s,n,!0);let d=s/h/2,g=n/l/2,y=d/2,v=g/2;for(let w=0;w<h;++w)for(let E=0;E<l;++E)i.drawImage(r,w*c+p,E*u+f,p,f,w*2*d,E*2*g,y,v),i.drawImage(r,w*c,E*u+f,c,f,w*2*d+y,E*2*g,d,v),i.drawImage(r,w*c,E*u+f,p,f,w*2*d+y*3,E*2*g,y,v),i.drawImage(r,w*c+p,E*u,p,u,w*2*d,E*2*g+v,y,g),i.drawImage(r,w*c,E*u,c,u,w*2*d+y,E*2*d+v,d,g),i.drawImage(r,w*c,E*u,p,u,w*2*d+y*3,E*2*g+v,y,g),i.drawImage(r,w*c+p,E*u,p,f,w*2*d,E*2*g+v*3,y,v),i.drawImage(r,w*c,E*u,c,f,w*2*d+y,E*2*g+v*3,d,v),i.drawImage(r,w*c,E*u,p,f,w*2*d+y*3,E*2*g+v*3,y,v);a[m]=i.toImage()}return r.mipmap=a}function ci(r,e=[32,16]){let t=r.width,i=r.height,[s,n]=e,a=t/s,h=i/n,l=new ge(a,h);r.texture4array=[];for(let c=0;c<n;++c)for(let u=0;u<s;++u)l.cropAndZoom(r,u*a,c*h,a,h),r.texture4array.push(l.toImage());return r.texture4array.tileCount=e,r.texture4array.singleW=a,r.texture4array.singleH=h,r.texture4array.altesCount=s*n,r.texture4array}const je=document.createElement("style");je.id="mc-root-style";document.head.prepend(je);function de(r,e,{slice:t=[],isBorder:i=t.length!==0,url:s=e.src,width:n=e.width,height:a=e.height}={}){return t.length===1&&(t=[t[0],t[0],t[0],t[0]]),t.length===2&&(t=[t[0],t[1],t[0],t[1]]),t.length===3&&(t=[t[0],t[1],t[2],t[1]]),je.sheet.insertRule(`:root {
        --mc-ui-${r}-img: url("${s}");
        --mc-ui-${r}-img-width: ${n};
        --mc-ui-${r}-img-height: ${a};`+(i?`
        --mc-ui-${r}-img-border-top: ${t[0]};
        --mc-ui-${r}-img-border-right: ${t[1]};
        --mc-ui-${r}-img-border-bottom: ${t[2]};
        --mc-ui-${r}-img-border-left: ${t[3]};`:"")+`
    }`,0),Re(`mc-ui-${r}-img`,e),e}const Pt=(r,e,t)=>(i,s,n,a,h,l,c)=>de(h,e.cropAndZoom(r,i,s,n,a,t,c).toImage(),l);ce("texture/gui.png").then(r=>{const e=r.width/256,t=new ge,i=Pt(r,t,e);i(0,66,200,20,"button",{slice:[3]}),de("slider-thumb",t.toImage(),{slice:[3,4]}),i(0,86,200,20,"button-hover",{slice:[3]}),de("slider-thumb-hover",t.toImage(),{slice:[3,4]}),i(0,46,200,20,"button-active",{slice:[3]}),de("button-disabled",t.toImage(),{slice:[3]}),i(0,0,182,22,"hotbar-background"),je.sheet.insertRule(":root { --mc-ui-hotbar-item-cell-width: 20; --mc-ui-hotbar-item-cell-height: 20; }",0),i(0,22,24,24,"hotbar-selector-background"),i(200,46,16,16,"inventory-item-background"),i(228,248,28,8,"hotbar-inventory-btn-foreground");for(let[s,n]of Object.entries({up:[0,107,26,26],left:[26,107,26,26],down:[52,107,26,26],right:[78,107,26,26],jump:[104,107,26,26],upleft:[0,133,26,26],upright:[26,133,26,26],flyup:[52,133,26,26],flydown:[78,133,26,26],fly:[104,133,26,26],sneak:[218,82,18,18]}))i(...n,"move-btn-"+s),de(`move-btn-${s}-active`,t.darken().toImage())});ce("texture/spritesheet.png").then(r=>{const e=r.width/256,t=new ge,i=Pt(r,t,e);i(60,0,18,18,"close-btn"),i(78,0,18,18,"close-btn-active"),i(34,43,14,14,"inventory-items",{slice:[3]}),i(49,43,13,14,"inventory-tab-background-left",{slice:[3]}),i(65,55,14,14,"inventory-tab-background-right",{slice:[3]}),i(8,32,8,8,"hotbar-inventory-btn-bg",{slice:[1]}),i(0,32,8,8,"hotbar-inventory-btn-bg-active",{slice:[1]})});ce("texture/background.png").then(r=>{const e=r.width/16,t=new ge;t.cropAndZoom(r,0,0,16,16,e,{canvasW:128,canvasH:128}),de("background",t.toImage()),de("background-darken",t.darken().toImage())});ce("texture/panorama.png").then(r=>{const{width:e,height:t}=r,i=new ge(t,t);let s=[];for(let n=0;n<6;++n){let a="pz,px,nz,nx,py,ny".split(",")[n];i.cropAndZoom(r,n*t,0,t,t),s[a]=i.toImage(),Re("welcomePage/texture_"+a,s[a])}for(let n of"px,nx,py,ny,pz,nz".split(","))s.push(s[n]);Re("welcomePage/textures",s)});ce("texture/title.png");class ui extends ct{constructor(){let e=document.createElement("canvas");super(e),this.canvas=e,this.ctx2d=new ge,this.setSize(512,512);const{ctx:t}=this;t.enable(t.DEPTH_TEST);const{SQRT2:i}=Math,s=.425+i/4;let n=new Q(this.aspectRatio,{projectionType:Q.projectionType.ortho,viewType:Q.viewType.lookAt,left:-s,right:s,bottom:-s,top:s,near:-1,far:5,position:[1,12/16,1]});this.mainCamera=n,this.addCamera(n),this.prg=this.isWebGL2?this.createProgram("blockInventoryTexure",wt.vert,wt.frag):this.createProgram("blockInventoryTexure",Tt.vert,Tt.frag),this.bo={ver:this.createVbo([],t.DYNAMIC_DRAW),nor:this.createVbo([],t.DYNAMIC_DRAW),col:this.createVbo([],t.DYNAMIC_DRAW),tex:this.createVbo([],t.DYNAMIC_DRAW),ele:this.createIbo([],t.DYNAMIC_DRAW)},this.mM=H().E().translate([-.5,-.5,-.5]).res,this.mvpM=H.mul(n.projview,this.mM),this.itmM=H().set(this.mM).inv().T().res}toImage(){let e=new Image(this.canvas.width,this.canvas.height);return e.src=this.canvas.toDataURL(),e}gen(e){if(e.name==="air")return this.ctx2d.clear(),this.ctx2d.toImage();if(e.renderType===C.renderType.NORMAL||e.renderType===C.renderType.CACTUS){let h=[],l=[],c=[],u=[],p=[],f=0;for(let y in e.vertices){let v=e.vertices[y],w=[v[0],v[1],v[2]],E=[v[3],v[4],v[5]],A=[v[6],v[7],v[8]],k=I(E).sub(w).cross(I.sub(A,w,A)).res,T=v.length/3;for(let b=0;b<T;++b)h.push(...k),l.push(1,1,1,1);c.push(...v),u.push(...e.texture.uv[y]),p.push(...e.elements[y].map(b=>b+f)),f+=T}const m=this.getOrCreateTexture(e.texture.img),{ctx:d,prg:g}=this;return this.bindBoData(this.bo.ver,c,{drawType:d.DYNAMIC_DRAW}),this.bindBoData(this.bo.nor,h,{drawType:d.DYNAMIC_DRAW}),this.bindBoData(this.bo.col,l,{drawType:d.DYNAMIC_DRAW}),this.bindBoData(this.bo.tex,u,{drawType:d.DYNAMIC_DRAW}),this.bindBoData(this.bo.ele,p,{drawType:d.DYNAMIC_DRAW}),g.use().bindTex("blockTex",m).setUni("diffuseLightColor",e.luminance?[0,0,0]:[1,1,1]).setUni("ambientLightColor",e.luminance?[1,1,1]:[.2,.2,.2]).setUni("diffuseLightDirection",I.normalize([.5,3,4])).setUni("diffuseLightDirection",I.normalize([.4,1,.7])).setUni("mvpMatrix",this.mvpM).setUni("normalMatrix",this.itmM).setAtt("position",this.bo.ver).setAtt("normal",this.bo.nor,3).setAtt("color",this.bo.col).setAtt("textureCoord",this.bo.tex),d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT),d.bindBuffer(this.bo.ele.type,this.bo.ele),d.drawElements(d.TRIANGLES,this.bo.ele.length,d.UNSIGNED_SHORT,0),d.flush(),this.toImage()}const{ctx2d:t}=this;t.clear();const i=e.texture.img.mipmap?e.texture.img.mipmap[0]:e.texture.img,s=i.width,n=i.height,a=Object.values(e.texture.uv)[0];if(i.texture4array){const h=i.texture4array,{singleW:l,singleH:c}=h;Array.isArray(h)?t.drawImage(h[a[2]],0,0,l,c,0,0,this.canvas.width,this.canvas.height):t.drawImage(h,0,c*a[2],l,c,0,0,this.canvas.width,this.canvas.height)}else t.drawImage(i,s*a[0],n*a[1],s*(a[6]-a[0]),n*(a[4]-a[1]),0,0,this.canvas.width,this.canvas.height);return t.toImage()}setSize(e,t,i=1){super.setSize(e,t,i),this.ctx2d.setSize(e,t)}}const di=new ui;function pi(r){return di.gen(r)}class he extends Number{constructor(e=0,t=0){super(t<<16|e)}get id(){return this&65535}get bd(){return this>>>16}}let Xe=null,st=null;const se={NORMAL:Symbol("block render type: normal"),FLOWER:Symbol("block render type: flower"),CACTUS:Symbol("block render type: cactus"),FLUID:Symbol("block render type: fluid")},Ke={},ye={},fi=()=>{for(let r=0;r<=65535;++r)if(!(r in ye))return r;return-1};class C{constructor(e,{opacity:t=15,luminance:i=0,renderType:s=C.renderType.NORMAL,stackable:n=64,textureImg:a=Xe,texture:h=[[16,32]],friction:l=1,id:c=fi(),bd:u=0,showName:p=e.toLowerCase().replace(/_/g," ").replace(/^\w|\s\w/g,v=>v.toUpperCase()),isLeaves:f=e.endsWith("leaves"),isGlass:m=e.endsWith("glass"),isFluid:d=s==C.renderType.FLUID,maxLevel:g=8,...y}={}){this.name=e,this.isFluid=d,d&&(this.maxLevel=g-1),this.renderType=s,this.vertices=C.getVerticesByRenderType(s),this.elements=C.getElementsByRenderType(s),this.texture=C.getTexUVByTexCoord({renderType:s,name:e,coordinate:h,texImg:a}),this.opacity=t,this.luminance=i,this.stackable=n,this.friction=l,this.id=c,this.bd=u,this.longID=new he(c,u),ye[this.longID]=this,Ke[e]=this,this.texture.inventory=pi(this),this.showName=p,this.isLeaves=f,this.isGlass=m;for(let v in y)this[v]=y[v]}get isOpaque(){return this.opacity===15}get isTransparent(){return this.opacity===0}get isTranslucent(){return this.opacity!==0&&this.opacity!==15}static getTexUVByTexCoord({renderType:e,name:t="Block",coordinate:i=[[16,32]],texImg:s=Xe}={}){for(let m of i){let[d,g]=m;m[0]=g-1,m[1]=d-1}const n={},a={img:s,uv:n,coordinate:i};let h=1/32,l=1/16,c=m=>s.mipmap?m/4:0,u=s.texture4array?s.texture4array.tileCount[0]:c(h),p=s.texture4array?s.texture4array.tileCount[1]:c(l),f=s.texture4array?([m,d])=>[0,0,m+d*u,0,1,m+d*u,1,1,m+d*u,1,0,m+d*u]:([m,d])=>[m*h+u,d*l+p,0,m*h+u,(d+1)*l-p,0,(m+1)*h-u,(d+1)*l-p,0,(m+1)*h-u,d*l+p,0];switch(e){case se.CACTUS:case se.NORMAL:{switch(i.length){case 1:{let m=f(i[0]);"x+,x-,y+,y-,z+,z-".split(",").map(d=>n[d]=m);break}case 2:{n["y+"]=n["y-"]=f(i[0]);let m=f(i[1]);"x+,x-,z+,z-".split(",").forEach(d=>n[d]=m);break}case 3:{n["y+"]=f(i[0]),n["y-"]=f(i[1]);let m=f(i[2]);"x+,x-,z+,z-".split(",").forEach(d=>n[d]=m);break}case 4:{n["y+"]=f(i[0]),n["y-"]=f(i[1]),n["x+"]=n["x-"]=f(i[2]),n["z+"]=n["z-"]=f(i[3]);break}case 6:{"x+,x-,y+,y-,z+,z-".split(",").forEach((m,d)=>n[m]=f(i[d]));break}default:throw t+" texture translate error: array length"}break}case se.FLOWER:{if(i.length>2)throw t+" texture translate error: array length";let m=f(i[0]);n.face=[...m,...m];break}case se.FLUID:{if(i.length>2)throw t+" texture translate error: array length";let m=f(i[0]);"x+,x-,y+,y-,z+,z-".split(",").forEach(d=>n[d]=m);break}}return a}static get renderType(){return se}static getVerticesByRenderType(e){return st.vertices[e]||{}}static getElementsByRenderType(e){return Object.entries(this.getVerticesByRenderType(e)).map(([t,i])=>({[t]:(s=>{if(!s)return[];let n=[0,1,2,0,2,3],a=[];for(let h=0,l=0;h<s;l=++h*4)a.push(...n.map(c=>c+l));return a})(i.length/12)})).reduce((t,i)=>({...t,...i}),{})}static getBlockByBlockName(e){return Ke[e]||null}static getBlockByBlockIDandData(e,t=0){return ye[new he(e,t)]||ye[e]||null}static getBlockByBlockLongID(e){let t=ye[e];return t||(e=e instanceof he?e:new he(e),ye[e.id]||null)}static listBlocks(){return Object.values(Ke)}static get defaultBlockTextureImg(){return Xe}}C.preloaded=Promise.all([ce("texture/terrain-atlas.png").then(r=>{Xe=r,isSupportWebGL2?ci(r):hi(r)}),ce("src/World/blocks.json").then(r=>{let e=r.index_renderType=[];Object.entries(r.block_renderType_index).forEach(([i,s])=>{e[s]=se[i.toUpperCase()]}),Object.entries(r.blocks).forEach(([,i])=>{"renderType"in i&&(i.renderType=e[i.renderType])});let t=r.block_renderType_vertex;r.vertices={[se.NORMAL]:"x+:2763,x-:0541,y+:0123,y-:4567,z+:1472,z-:3650".split(",").map(i=>i.split(":")).map(([i,s])=>({[i]:[...s].map(n=>t.normal[n]).reduce((n,a)=>(n.push(...a),n),[])})).reduce((i,s)=>({...i,...s}),{}),[se.FLOWER]:"face:14630572".split(",").map(i=>i.split(":")).map(([i,s])=>({[i]:[...s].map(n=>t.flower[n]).reduce((n,a)=>(n.push(...a),n),[])})).reduce((i,s)=>({...i,...s}),{}),[se.CACTUS]:"x+:12 13 14 15,x-:20 21 22 23,y+:0 1 2 3,y-:4 5 6 7,z+:8 9 10 11,z-:16 17 18 19".split(",").map(i=>i.split(":")).map(([i,s])=>({[i]:s.split(" ").map(n=>t.cactus[n]).reduce((n,a)=>(n.push(...a),n),[])})).reduce((i,s)=>({...i,...s}),{}),[se.FLUID]:"x+:2763,x-:0541,y+:0123,y-:4567,z+:1472,z-:3650".split(",").map(i=>i.split(":")).map(([i,s])=>({[i]:[...s].map(n=>t.fluid[n]).reduce((n,a)=>n.concat(a),[])})).reduce((i,s)=>({...i,...s}),{})},st=r})]).then(()=>{Object.entries(st.blocks).forEach(([r,e])=>{new C(r,e)})});class gi extends Uint8Array{constructor(){super(z*V*$)}get(e,t,i){return this[L.getLinearBlockIndex(e,t,i)]}set(e,t,i,s){return this[L.getLinearBlockIndex(e,t,i)]=s}getSkylight(e,t,i){return this[L.getLinearBlockIndex(e,t,i)]&15}getTorchlight(e,t,i){return this[L.getLinearBlockIndex(e,t,i)]>>4&15}getMax(e,t,i){let s=this[L.getLinearBlockIndex(e,t,i)];return Math.max(s&15,s>>4&15)}setSkylight(e,t,i,s){let n=L.getLinearBlockIndex(e,t,i);return this[n]=this[n]&240|s,s}setTorchlight(e,t,i,s){let n=L.getLinearBlockIndex(e,t,i);return this[n]=this[n]&15|s<<4,s}}class mi{constructor(e){this.setWorld(e)}setWorld(e){this.world=e;let t=Object.values(e.chunkMap),i=t.sort(({y:n,y:a})=>a-n).reduce((n,a)=>(a.y===t[0].y&&n.push(a),n),[]),s=[];i.forEach(n=>{for(let a=0;a<$;++a)for(let h=0;h<V;++h){let l=n.getBlock(a,z-1,h);if(l.isOpaque)continue;let c=l.isTransparent?15:15-l.opacity-1;n.lightMap.setSkylight(a,z-1,h,c),c>1&&s.push([a,z-1,h,n])}}),this.spreadSkylight(s),t.forEach(n=>{for(let a=0;a<$;++a)for(let h=0;h<z;++h)for(let l=0;l<V;++l){let c=n.getBlock(a,h,l);c.luminance&&(n.lightMap.setTorchlight(a,h,l,c.luminance),s.push([a,h,l,n]))}}),this.spreadTorchlight(s),e.addEventListener("onTileChanges",this.updateTile.bind(this)),e.addEventListener("onChunkLoad",n=>{this.buildChunkLight(n.chunkKey);for(let[a,h,l]of[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]])this.buildChunkLight(e.getChunkByChunkXYZ(n.x+a,n.y+h,n.z+l))})}spreadSkylight(e){const t=this.world,{max:i}=Math;for(;e.length;){let[s,n,a,h]=e.shift(),l=h.lightMap.getSkylight(s,n,a),c=h.getBlock(s,n,a);h.updatedLightMap=!0;for(let[u,p,f]of[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]]){let m=s+u,d=n+p,g=a+f,y=h;if(h.inOtherChunk(m,d,g)&&([m,d,g]=L.getRelativeBlockXYZ(m,d,g),y=t.getChunkByChunkXYZ(h.x+u,h.y+p,h.z+f),y===null))continue;let v=y.getBlock(m,d,g);if(v.isOpaque)continue;if(l===15&&p===-1&&v.isTransparent){y.lightMap.setSkylight(m,d,g,15),e.push([m,d,g,y]);continue}let w=y.lightMap.getSkylight(m,d,g);l-v.opacity-1>w?(y.lightMap.setSkylight(m,d,g,i(0,l-v.opacity-1)),e.push([m,d,g,y])):w-c.opacity-1>l&&(h.lightMap.setSkylight(s,n,a,w-c.opacity-1),e.push([s,n,a,h]))}}}spreadTorchlight(e){const t=this.world;for(;e.length;){let[i,s,n,a]=e.shift(),h=a.lightMap.getTorchlight(i,s,n),l=a.getBlock(i,s,n);if(a.updatedLightMap=!0,!(h<=1))for(let[c,u,p]of[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]]){let f=i+c,m=s+u,d=n+p,g=a;if(a.inOtherChunk(f,m,d)&&([f,m,d]=L.getRelativeBlockXYZ(i+c,s+u,n+p),g=t.getChunkByChunkXYZ(a.x+c,a.y+u,a.z+p),g===null))continue;let y=g.getBlock(f,m,d);if(y.isOpaque)continue;let v=g.lightMap.getTorchlight(f,m,d);if(h-y.opacity-1>v){g.lightMap.setTorchlight(f,m,d,h-y.opacity-1),e.push([f,m,d,g]);continue}else if(v-l.opacity-1>h){a.lightMap.setTorchlight(i,s,n,v-l.opacity-1),e.push([i,s,n,a]);continue}}}}removeSkylight(e){const t=this.world,i=[];for(;e.length;){let[s,n,a,h,l]=e.shift();l.updatedLightMap=!0;for(let[c,u,p]of[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]]){let f=s+c,m=n+u,d=a+p,g=l;if(l.inOtherChunk(f,m,d)&&([f,m,d]=L.getRelativeBlockXYZ(s+c,n+u,a+p),g=t.getChunkByChunkXYZ(l.x+c,l.y+u,l.z+p),g===null))continue;let y=g.getBlock(f,m,d),v=g.lightMap.getSkylight(f,m,d);if(v===15&&u===-1&&y.isTransparent){g.lightMap.setSkylight(f,m,d,0),e.push([f,m,d,v,g]);continue}else if(v!==0&&v<h){g.lightMap.setSkylight(f,m,d,0),e.push([f,m,d,v,g]);continue}else if(v>=h){i.push([f,m,d,g]);continue}}}return i}removeTorchlight(e){const t=this.world,i=[];for(;e.length;){let[s,n,a,h,l]=e.shift();l.updatedLightMap=!0;for(let[c,u,p]of[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]]){let f=s+c,m=n+u,d=a+p,g=l;if(l.inOtherChunk(f,m,d)&&([f,m,d]=L.getRelativeBlockXYZ(s+c,n+u,a+p),g=t.getChunkByChunkXYZ(l.x+c,l.y+u,l.z+p),g===null))continue;let y=g.getBlock(f,m,d),v=g.lightMap.getTorchlight(f,m,d);v!==0&&v<h&&y.luminance===0?(g.lightMap.setTorchlight(f,m,d,0),e.push([f,m,d,v,g])):(v>=h||y.luminance)&&i.push([f,m,d,g])}}return i}buildChunkLight(e){const{world:t}=this,i=t.getChunkByChunkKey(e);if(!i)return;let s=[],n=i.lightMap;for(let a=0;a<z;++a)for(let h=0;h<V;++h)for(let l=0;l<$;++l){let c=i.getBlock(l,a,h);n.setSkylight(l,a,h,0);let u=c.luminance;n.setTorchlight(l,a,h,u),u&&s.push([l,a,h,i])}this.spreadTorchlight(s),[[0,$-1,0,0,0,V-1],[0,$-1,z-1,z-1,0,V-1],[0,0,0,z-1,0,V-1],[$-1,$-1,0,z-1,0,V-1],[0,$-1,0,z-1,0,0],[0,$-1,0,z-1,V-1,V-1]].forEach(([a,h,l,c,u,p])=>{let f=a===h?a?1:-1:0,m=l===c?l?1:-1:0,d=u===p?u?1:-1:0;for(let g=a;g<=h;++g)for(let y=l;y<=c;++y)for(let v=u;v<=p;++v){let w=i.getBlock(g,y,v);if(w.isOpaque)continue;let E=t.getSkylight(...i.blockRXYZ2BlockXYZ(g+f,y+m,v+d));if(E===null&&m!==1)return;let A=i.lightMap.getSkylight(g,y,v),k=Math.max(A,m==1&&(E===null||E===15)?15:E-w.opacity-1);k>1&&(n.setSkylight(g,y,v,k),s.push([g,y,v,i]))}}),this.spreadSkylight(s)}updateTile(e,t,i){const s=this.world,n=s.getChunkByBlockXYZ(e,t,i);if(n===null)return;const a=s.getBlock(e,t,i);let h=t,l=null,c=[];const u=(d,g,y,v)=>{let w=s.getChunkByBlockXYZ(d,g,y);if(w===null)return;let E=L.getRelativeBlockXYZ(d,g,y);w.lightMap.setSkylight(...E,v),c.push([...E,w])};for(;(l=s.getBlock(e,++h,i))&&!l.isTransparent;);for(let d=h-1,g;g=s.getBlock(e,d,i),!(g===null||g.isTransparent);--d)l!==null?u(e,d,i,0):s.getSkylight(e,d,i)!==15&&u(e,d,i,15);let p=[];p.push([...L.getRelativeBlockXYZ(e,t,i),s.getSkylight(e,t,i),n]),u(e,t,i,l===null?15-a.opacity:0),c.push(...this.removeSkylight(p)),this.spreadSkylight(c);const f=(d,g,y,v)=>{let w=s.getChunkByBlockXYZ(d,g,y);if(w===null)return;let E=L.getRelativeBlockXYZ(d,g,y);w.lightMap.setTorchlight(...E,v),c.push([...E,w])};let m=s.getTorchlight(e,t,i);if(m>a.luminance){let d=[[...L.getRelativeBlockXYZ(e,t,i),m,n]];f(e,t,i,0),c.push(...this.removeTorchlight(d))}f(e,t,i,a.luminance),a.luminance||[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]].forEach(([d,g,y])=>{let v=e+d,w=t+g,E=i+y,A=s.getTorchlight(v,w,E);A!==null&&A!==0&&c.push([...L.getRelativeBlockXYZ(v,w,E),s.getChunkByBlockXYZ(v,w,E)])}),this.spreadTorchlight(c)}onRender(e,t){}onTick(){}}const nt=4,Le=4,ve=4,$=1<<nt,z=1<<Le,V=1<<ve;class L extends be{static get X_SIZE(){return $}static get Y_SIZE(){return z}static get Z_SIZE(){return V}static getChunkXYZByBlockXYZ(e,t,i){return[e>>nt,t>>Le,i>>ve]}static chunkKeyByChunkXYZ(e,t,i){return e+","+t+","+i}static chunkKeyByBlockXYZ(e,t,i){return(e>>nt)+","+(t>>Le)+","+(i>>ve)}static getRelativeBlockXYZ(e,t,i){const s=(n,a)=>(a+n%a)%a;return[s(e,$),s(t,z),s(i,V)]}static getLinearBlockIndex(e,t,i){return((t<<Le)+i<<ve)+e}static getBlockRXYZBytLinearBlockIndex(e){let t=e&$-1,i=e>>ve&V-1,s=e>>Le>>ve&z-1;return[t,s,i]}static getChunkXYZByChunkKey(e){return e.split(",").map(Number)}constructor(e,t,i,s,n=e.renderer,a=e.generator){super(),this.world=e,this.x=t,this.y=i,this.z=s,this.chunkKey=L.chunkKeyByChunkXYZ(t,i,s),this.tileMap=new Uint32Array(z*V*$),this.lightMap=new gi,this.generator=a,a(t,i,s,this.tileMap),this.setRenderer(n)}setRenderer(e=null){return this.renderer=e,this}getTile(e,t,i){return new he(this.tileMap[L.getLinearBlockIndex(e,t,i)])}getBlock(e,t,i){return C.getBlockByBlockLongID(this.getTile(e,t,i))}setTileByBlock(e,t,i,s,n=s==null?void 0:s.id,a=s==null?void 0:s.bd){if(!s)return s;let h=L.getLinearBlockIndex(e,t,i),l=new he(this.tileMap[h]),c=C.getBlockByBlockLongID(l),u=new he(n,a);return this.tileMap[h]=u,this.dispatchEvent("onTileChanges",e,t,i,{longID:u,block:s},{longID:l,block:c}),s}setTile(e,t,i,s,n){return this.setTileByBlock(e,t,i,C.getBlockByBlockIDandData(s,n),s,n)}setBlock(e,t,i,s){return this.setTileByBlock(e,t,i,C.getBlockByBlockName(s))}getLight(e,t,i){return this.lightMap.getMax(e,t,i)}getSkylight(e,t,i){return this.lightMap.getSkylight(e,t,i)}getTorchlight(e,t,i){return this.lightMap.getTorchlight(e,t,i)}static inOtherChunk(e,t,i){return e<0||e>=$||i<0||i>=V||t<0||t>=z}inOtherChunk(e,t,i){return e<0||e>=$||i<0||i>=V||t<0||t>=z}blockRXYZ2BlockXYZ(e,t,i){return[e+this.x*$,t+this.y*z,i+this.z*V]}onTick(){}onRender(e,t){}}class Ft{constructor(e,{eyePos:t=[(e.min[0]+e.min[0])/2,(e.min[1]+e.min[1])/2,(e.min[2]+e.min[2])/2],pitch:i=0,yaw:s=0,position:n=[0,0,0],world:a=null,controller:h=null,camera:l=null,uid:c=performance.timeOrigin+performance.now()+"-"+Math.random()}={}){this.moveSpeed=0,this.gravityAcceleration=0,this.position=I.create(...n),this.pitch=i,this.yaw=s,this.hitboxes=e,this.eyePos=I.create(...t),this.forward=I.create(),this.direction=I.create(),this.model=null,this.setWorld(a),this.setCamera(l),this.setController(h),this.uid=c,this.type="Entity"}getEyePosition(){return I.add(this.eyePos,this.position)}getGloBox(){return{min:I.add(this.hitboxes.min,this.position),max:I.add(this.hitboxes.max,this.position)}}getDirection(e=1){return I(this.direction).create(0,0,-e).rotateX(this.pitch).rotateY(this.yaw).res}setCamera(e=null){if(e===this.camera)return this;const t=this.camera;return this.camera=e,t&&t.bindEntity(null),e&&e.bindEntity(this),this}setController(e=null){if(e===this.controller)return this;const t=this.controller;return this.controller=e,t&&t.setEntity(null),e&&e.setEntity(this),this}setWorld(e=null){return this.world=e,this}onRender(e,t){}onTick(){}toObj(){const e=t=>Array.from(t);return{moveSpeed:this.moveSpeed,gravityAcceleration:this.gravityAcceleration,position:e(this.position),pitch:this.pitch,yaw:this.yaw,hitboxes:{min:this.hitboxes.min,max:this.hitboxes.max},eyePos:e(this.eyePos),forward:e(this.forward),direction:e(this.direction),uid:this.uid,type:this.type}}}class ze extends Ft{static from(e){let t=new ze(null,e);for(let i in e)t[i].buffer instanceof ArrayBuffer?t[i].set(e[i]):t[i]=e[i];return t}constructor(e=null,{position:t=[0,10,0],pitch:i=0,yaw:s=0,uid:n}={}){super({min:[-.25,0,-.25],max:[.25,1.8,.25]},{eyePos:[0,1.65,0],position:t,pitch:i,yaw:s,world:e,uid:n}),super.type="Player",this.normalMoveSpeed=4.317,this.runMoveSpeed=5.612,this.flyMoveSpeed=11,this.flyRunMoveSpeed=22,this.moveSpeed=this.normalMoveSpeed,super.gravityAcceleration=30,this.jumpSpeed=Math.sqrt(2*this.gravityAcceleration*1.25),this.normalJumpSpeed=this.jumpSpeed,this.flyJumpSpeed=20,this._horiMoveDir=Z.create(),this.horiVelocity=Z.create(),this.horiAcceleration=0,this._vertMoveDir=0,this.vertVelocity=0,this.vertAcceleration=-this.gravityAcceleration,this.rest=I.create(),this.lastChunk=[],this.isFly=!1,this.isRun=!1,this._onHandItem=C.getBlockByBlockName("air"),this._velocity=I.create(),this._acceleration=I.create(),this.eyeInFluid=!1}get onHandItem(){return this._onHandItem}set onHandItem(e){e instanceof C?this._onHandItem=e:typeof e=="string"&&(this._onHandItem=C.getBlockByBlockName(e)||this._onHandItem)}get horiMoveDir(){return this._horiMoveDir}set horiMoveDir(e){Z(this._horiMoveDir).set(e).norm()}get vertMoveDir(){return this._vertMoveDir}set vertMoveDir(e){this._vertMoveDir=e?e>0?1:-1:0}get velocity(){return I.create(this.horiVelocity[0],this.vertVelocity,this.horiVelocity[1],this._velocity)}get acceleration(){return I.create(this.horiAcceleration,this.vertAcceleration,this.horiAcceleration,this._acceleration)}toFlyMode(e=!1){this.isFly=e,e?(this.vertAcceleration=0,this.moveSpeed=this.isRun?this.flyRunMoveSpeed:this.flyMoveSpeed):(this.vertAcceleration=-this.gravityAcceleration,this.moveSpeed=this.isRun?this.normalMoveSpeed:this.runMoveSpeed)}toRunMode(e=!1){this.isRun=e,e?(this.moveSpeed=this.isFly?this.flyRunMoveSpeed:this.runMoveSpeed,this.camera&&this.camera.changeFovyWithAnimation(10)):(this.moveSpeed=this.isFly?this.flyMoveSpeed:this.normalMoveSpeed,this.camera&&this.camera.changeFovyWithAnimation(0))}get onGround(){return this.rest[1]===-1}moveAndCollide(e,t){var n;let i=I.scale(e,t),s=(a,h,l)=>{let c=this.world.getBlock(a,h,l);return c&&c.name!=="air"&&c.renderType!==C.renderType.FLOWER&&c.renderType!==C.renderType.FLUID};I.create(0,0,0,this.rest);for(let a=0,h=I.create();a<3;h[a++]=0){h[a]=i[a];let l=this.world.hitboxesCollision(this.getGloBox(),h,s);for(;l;)this.position[l.axis]=l.pos-(l.step>0?this.hitboxes.max[l.axis]:this.hitboxes.min[l.axis]),this.rest[l.axis]=l.step,e[l.axis]=i[l.axis]=h[l.axis]=0,l.axis!==1&&this.toRunMode(!1),l=this.world.hitboxesCollision(this.getGloBox(),h,s)}this.horiVelocity.set([e[0],e[2]]),this.vertVelocity=e[1],I.add(this.position,i,this.position),this.eyeInFluid=((n=this.world.getBlock(...this.getEyePosition()))==null?void 0:n.isFluid)??!1}onRender(e,t){if(super.onRender(e,t),!!this.world){if(t/=1e3,this.isFly?(this.vertVelocity=this.vertMoveDir*this.flyJumpSpeed,this.vertVelocity+=this.vertAcceleration*t):(this.onGround&&(this.vertVelocity=Math.max(0,this.vertMoveDir)*this.jumpSpeed),this.vertVelocity+=this.vertAcceleration*t),this.isFly)this.horiAcceleration=12;else{let i=this.position,s=this.world.getBlock(i[0],i[1]-1,i[2]),n=s&&s.friction||1;this.horiAcceleration=n*20}if(Z.length(this.horiMoveDir)>le){let i=Z.angle([0,1],this.horiMoveDir),s=Z.rotateOrigin([0,-this.moveSpeed],-(this.yaw+i));Z.moveToward(this.horiVelocity,s,this.horiAcceleration*t,this.horiVelocity)}else Z.moveToward(this.horiVelocity,[0,0],this.horiAcceleration*t,this.horiVelocity);this.moveAndCollide(this.velocity,t)}}toObj(){const e=t=>Array.from(t);return{...super.toObj(),normalMoveSpeed:this.normalMoveSpeed,runMoveSpeed:this.runMoveSpeed,flyMoveSpeed:this.flyMoveSpeed,flyRunMoveSpeed:this.flyRunMoveSpeed,moveSpeed:this.moveSpeed,jumpSpeed:this.jumpSpeed,normalJumpSpeed:this.normalJumpSpeed,flyJumpSpeed:this.flyJumpSpeed,horiMoveDir:e(this.horiMoveDir),horiVelocity:e(this.horiVelocity),horiAcceleration:this.horiAcceleration,vertMoveDir:this.vertMoveDir,vertVelocity:this.vertVelocity,vertAcceleration:this.vertAcceleration,rest:e(this.rest),lastChunk:e(this.lastChunk),isFly:this.isFly,isRun:this.isRun,onHandItem:this.onHandItem.longID,eyeInFluid:this.eyeInFluid}}}function ie(r,e,t){return(1-t)*r+t*e}function Ae(r){return r*r*r*(r*(r*6-15)+10)}const He=9007199254740881;function Nt(r){let e=Number(r);if(Number.isNaN(e)||(r=e),typeof r=="number")Number.isInteger(r)?e=r%He:(r*=Math.PI,e=Number(r.toString().replace(".","").slice(0,16))%He);else if(typeof r=="string"){let t=0,i="";for(;t<r.length;++t){let s=r.charCodeAt(t);if((i+s).length>53)break;i+=s}for(e=Number(i);t<r.length;++t)e=((e+r.charCodeAt(t))*48271+57)%He}return e}class yi{constructor(e=Date.now()){this.seed=Nt(e)}}class vi extends yi{constructor(e=Date.now()){super(e),this.x=e}nextInt(e){return this.x=(48271*this.x+57)%He,e?this.x%e:this.x}}class wi{constructor(e=Date.now()){this.setSeed(e);let t=this.random=new vi(this.seed),i=[...Array(256)].map((s,n)=>n);for(let s=0,n,a;s<256;++s)n=t.nextInt(256-s)+s,a=i[s],i[s]=i[s+256]=i[n],i[n]=a;this.permutations=i}setSeed(e){this.originalSeed=e,this.seed=Nt(e)}getSeed(){return this.seed}}class Et extends wi{constructor(e){super(e);let t=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]].map(([s,n,a])=>I.create(s,n,a)),i=this.gradP=[];this.permutations.forEach(s=>i.push(t[s%12]))}gen(e,t,i){return t==1?this.gen2d(e,i):this.gen3d(e,t,i)}gen2d(e,t){const{floor:i}=Math,s=this.permutations,n=this.gradP;let a=i(e),h=i(t),l=e-a,c=t-h;a&=255,h&=255;let u=Z.dot(n[a+s[h]],[l,c]),p=Z.dot(n[a+s[h+1]],[l,c-1]),f=Z.dot(n[a+s[h]+1],[l-1,c]),m=Z.dot(n[a+s[h+1]+1],[l-1,c-1]),d=Ae(l);return ie(ie(u,f,d),ie(p,m,d),Ae(c))}gen3d(e,t,i){const{floor:s}=Math,{gradP:n,permutations:a}=this;let h=s(e),l=s(t),c=s(i);e-=h,t-=l,i-=c,h&=255,l&=255,c&=255;let u=I.dot(n[h+a[l+a[c]]],[e,t,i]),p=I.dot(n[h+a[l+a[c+1]]],[e,t,i-1]),f=I.dot(n[h+a[l+1+a[c]]],[e,t-1,i]),m=I.dot(n[h+a[l+1+a[c+1]]],[e,t-1,i-1]),d=I.dot(n[h+1+a[l+a[c]]],[e-1,t,i]),g=I.dot(n[h+1+a[l+a[c+1]]],[e-1,t,i-1]),y=I.dot(n[h+1+a[l+1+a[c]]],[e-1,t-1,i]),v=I.dot(n[h+1+a[l+1+a[c+1]]],[e-1,t-1,i-1]),w=Ae(e),E=Ae(t),A=Ae(i);return ie(ie(ie(u,d,w),ie(p,g,w),A),ie(ie(f,y,w),ie(m,v,w),A),E)}}class Ti{constructor(e){this.spreadQueue=[],this.removalQueue=[],this.updatingTile=!1,this.waterID=C.getBlockByBlockName("water").id,this.flowingWaterID=C.getBlockByBlockName("flowing_water").id,this.lavaID=C.getBlockByBlockName("lava").id,this.flowingLavaID=C.getBlockByBlockName("flowing_lava").id,this.timeCount=0,this.setWorld(e)}setWorld(e){this.world=e;const t=i=>{for(let s=0;s<$;++s)for(let n=0;n<z;++n)for(let a=0;a<V;++a){let{id:h,bd:l}=i.getBlock(s,n,a);(h==this.flowingWaterID||h==this.flowingLavaID)&&this.spreadQueue.push(i.blockRXYZ2BlockXYZ(s,n,a))}i.addEventListener("onTileChanges",(s,n,a,h,l)=>{this.updatingTile||!l.block.isFluid&&!h.block.isFluid||(h.block.isFluid?this.spreadQueue.push(i.blockRXYZ2BlockXYZ(s,n,a)):this.removalQueue.push([...i.blockRXYZ2BlockXYZ(s,n,a),l.longID.id,l.longID.bd]))})};Object.values(e.chunkMap).forEach(t),this.spreadFluid(),e.addEventListener("onChunkLoad",i=>{t(i),this.spreadFluid()})}spreadFluid(e=1/0,t=this.spreadQueue){const{world:i,waterID:s,lavaID:n,flowingWaterID:a,flowingLavaID:h}=this;for(;e-- >0&&t.length;){let l=[];const c=(u,p,f)=>{const m=u+","+p+","+f;l[m]||(l.push([u,p,f]),l[m]=!0)};for(;t.length;){let[u,p,f]=t.shift();if(i.getChunkByBlockXYZ(u,p,f)==null){c(u,p,f);continue}let d=i.getTile(u,p,f),g=d.id,y=d.bd,v=C.getBlockByBlockIDandData(g,y);const w=g==s||g==a?s:g==n||g==h?n:g,E=g==s||g==a?a:g==n||g==h?h:g;g!=w&&(i.setTile(u,p,f,w,y),g=w);let A=i.getBlock(u,p-1,f);d=i.getTile(u,p-1,f);let k=d==null?void 0:d.id,T=d==null?void 0:d.bd;if(A==null&&c(u,p,f),y>=8&&A!=null)if(A.name=="air"||k==w||k==E){A.name=="air"||T?i.setTile(u,p-1,f,E,y):i.setTile(u,p-1,f,E,T),c(u,p-1,f);continue}else y=0;if(y==v.maxLevel&&(A==null||A.name!="air")||A&&(A.name=="air"||k==w||k==E)&&(i.setTile(u,p-1,f,E,y+8),c(u,p-1,f),y!=0))continue;const b=(P,F)=>P+","+F;let B=[],x=y,M=[[[1,0],[-1,0],[0,1],[0,-1]].map(([P,F])=>[u+P,f+F])];for(;M.length&&x<=v.maxLevel;){++x;let P=M.shift(),F=[];for(M.push(F);P.length;){let[R,D]=P.shift(),_=i.getBlock(R,p-1,D);if(_&&(_.name=="air"||_.id==w||_.id==E))M.length=0,B.push([R,D]);else for(let[j,X]of[[1,0],[-1,0],[0,1],[0,-1]])M[b(R+j,D+X)]!=!0&&(F.push([R+j,D+X]),M[b(R+j,D+X)]=!0)}}let S=B.length?[[1,0],[-1,0],[0,1],[0,-1]].reduce((P,[F,R])=>{let D=u+F,_=f+R;const{abs:j}=Math;for(let[X,N]of B)if(j(D-X)+j(_-N)==x-1-y){P.push([F,R]);break}return P},[]):[[1,0],[-1,0],[0,1],[0,-1]];for(let[P,F]of S){let R=u+P,D=p,_=f+F,j=i.getBlock(R,D,_);if(j==null){c(R,D,_);continue}if(j.name=="air")i.setTile(R,D,_,E,y+1),c(R,D,_);else if(j.id==w||j.id==E){let X=i.getTile(R,D,_).bd;X>=8&&(X=0),X>y?(i.setTile(R,D,_,E,y+1),c(R,D,_)):X<y-1&&(i.setTile(R,D,_,E,X+1),c(R,D,_))}}}this.spreadQueue=t=l}}removeFluid(e=1/0,t=this.removalQueue){const{world:i,waterID:s,lavaID:n,flowingWaterID:a,flowingLavaID:h}=this;for(;e-- >0&&t.length;){let l=[];const c=(u,p,f)=>{const m=u+","+p+","+f;l[m]||(l.push([u,p,f]),l[m]=!0)};for(;t.length;){let[u,p,f,m,d]=t.shift();if(i.getChunkByBlockXYZ(u,p,f)==null){c(u,p,f);continue}C.getBlockByBlockIDandData(m,d)}this.removalQueue=t=l}}updateTile(e,t,i){this.updatingTile||!this.world.getBlock(e,t,i).isFluid||this.spreadQueue.push([e,t,i])}onRender(e,t){}onTick(){this.timeCount>=5&&(this.updatingTile=!0,this.spreadFluid(1),this.updatingTile=!1,this.timeCount=0),++this.timeCount}}class Bt{constructor(e){this.id=e;let t=this._getWorlds();e in t||(t[e]={createAt:Date.now(),modifyAt:Date.now()}),this._setWorlds(t)}_getWorlds(){return JSON.parse(localStorage.getItem("worlds")||"{}")}_setWorlds(e){localStorage.setItem("worlds",JSON.stringify(e))}_updateWorld(e){let t=this._getWorlds(),i=e(t[this.id]);return t[this.id].modifyAt=Date.now(),this._setWorlds(t),i}get(e,t){return e=e.split(">"),this._updateWorld(i=>{let s=i;for(let n of e)if(!(s=s[n]))return t;return s})}set(e,t){return e=e.split(">"),this._updateWorld(i=>{let s=null,n=i;for(let a=0;a<e.length;++a){let h=e[a];if(s=n,n=n[h],a!=e.length-1)n||(s[h]=n={});else return s[h]=t}})}del(e){return e=e.split(">"),this._updateWorld(t=>{let i=null,s=t;for(let n=0;n<e.length;++n){let a=e[n];if(i=s,s=s[a],!s)return;if(n==e.length-1)return delete i[a]}})}}class bi extends be{constructor({worldName:t="My World",worldType:i="pre-classic",renderer:s=null,seed:n=Date.now(),storageId:a=null}={}){super();q(this,"generator",(t,i,s,n)=>{switch(this.type){case"flat":let l=C.getBlockByBlockName(i>=0?"air":t%2?s%2?"grass":"stone":s%2?"stone":"grass");for(let c=0;c<n.length;++c)n[c]=l.longID;break;case"pre-classic":{const{X_SIZE:c,Y_SIZE:u,Z_SIZE:p}=L,f=this.noise,m=f.gen2d.bind(f);let d=C.getBlockByBlockName("air"),g=C.getBlockByBlockName(i%2?t%2?s%2?"grass":"stone":s%2?"stone":"grass":t%2?s%2?"stone":"grass":s%2?"grass":"stone"),y=f.gen3d.bind(f),v=[];for(let T=0;T<c;++T)for(let b=0;b<p;++b){let B=t*c+T,x=s*p+b,M=(m(B/200,x/200)+m(B/50,x/50)/2+m(B/10,x/10)/64)/2;M=Math.floor(M*128),v[T]=v[T]||[],v[T][b]=M;for(let S=0;S<u;++S){let P=i*u+S;if(P<M){let F=y(B/16,P/16,x/16),R=y(B/256,P/256,x/256)+y(B/128,P/128,x/128)/2+y(B/64,P/64,x/64)/4+y(B/25,P/25,x/25)/8,D=(y(B/5,P/5,x/5)+1)/2;n[L.getLinearBlockIndex(T,S,b)]=(D<.18||R>0&&F<-.1?d:g).longID}else v.haveSurface=v.haveSurface||P===M,n[L.getLinearBlockIndex(T,S,b)]=d.longID}}let w=[],E=5;for(let T=-E-2;T<c+E+2;++T)for(let b=-E-2;b<p+E+2;++b){let B=t*c+T,x=s*p+b;w[T]=w[T]||[],w[T][b]=(m(x/10,B/10)+1)/2+m(x/5,B/5)/2}let A=[],k=[];for(let T=-2;T<c+2;++T)for(let b=-2;b<p+2;++b){A[T]=A[T]||[];let B=-10;for(let x=-E;x<=E;++x)for(let M=-E;M<=E;++M){let S=w[T+x][b+M];S>B&&(B=S)}A[T][b]=w[T][b]===B}for(let T=0;T<c;++T)for(let b=0,B;b<p;++b)if(v[T][b]>=i*u&&v[T][b]<(i+1)*u){for(B=L.getRelativeBlockXYZ(0,v[T][b],0)[1];B>0;--B)if(C.getBlockByBlockLongID(n[L.getLinearBlockIndex(T,B-1,b)]).name!=="air"){v[T][b]=i*u+B;break}B==-1&&(v[T][b]=i*u)}for(let T=0;T<c;++T)for(let b=0;b<p;++b){let B=!0;for(let x=-2;x<=2&&B;++x)for(let M=-2;M<=2&&B;++M)A[T+x][b+M]&&(B=!1);k[T]=k[T]||[],k[T][b]=!B}for(let T=0;T<c;++T)for(let b=0;b<p;++b)for(let B=u-1;B>=0&&C.getBlockByBlockLongID(n[L.getLinearBlockIndex(T,B,b)]).name==="air";--B){let x=v[T][b],M=i*u+B,S=w[T][b]<.15;A[T][b]&&M-x<5&&v.haveSurface?n[L.getLinearBlockIndex(T,B,b)]=C.getBlockByBlockName("oak_log").longID:M-x<7&&M-x>3&&k[T][b]!==!1?n[L.getLinearBlockIndex(T,B,b)]=C.getBlockByBlockName("oak_leaves").longID:S&&M<=x&&B>0&&v.haveSurface&&C.getBlockByBlockLongID(n[L.getLinearBlockIndex(T,B-1,b)]).name!=="air"&&(n[L.getLinearBlockIndex(T,B,b)]=C.getBlockByBlockName("dandelion").longID)}break}}let a=L.chunkKeyByChunkXYZ(t,i,s),h=this.storager.get("chunks>"+a,{});for(let l in h)n[l]=new he(h[l])});q(this,"beforeTick",()=>{var s;let t=performance.now();t-this.lastTickTimestamp<=50?(this.lastTickTimestamp=t,this.tickTimerId=setTimeout(this.beforeTick,50)):(this.lastTickTimestamp+=50,this.tickTimerId=setTimeout(this.beforeTick,0)),(s=this.renderer)!=null&&s.isPlaying()&&(this.onTick(),this.dispatchEvent("tick"))});n===""&&(n=Date.now()),t===""&&(t="My World"),["flat","pre-classic"].includes(i)||(console.warn("Undefined world type: "+i),i="pre-classic"),a!=null?(this.storager=new Bt(a),n=this.storager.get("seed"),t=this.storager.get("name"),i=this.storager.get("type"),this.seed=n,this.noise=new Et(n)):(this.seed=n,this.noise=new Et(n),a=Date.now()+"-"+this.noise.seed,this.storager=new Bt(a),this.storager.set("name",t),this.storager.set("type",i),this.storager.set("seed",n)),this.name=t,this.type=i,this.chunkMap={},this.callbacks={};let h=this.storager.get("entities",[]);if(h.length){this.entities=h.map(c=>{switch(c.type){case"Player":return ze.from(c).setWorld(this)}});let l=this.storager.get("mainPlayer");this.mainPlayer=this.entities.find(c=>c.uid==l)}else this.mainPlayer=new ze(this),this.entities=[this.mainPlayer],this.saveEntities(),this.storager.set("mainPlayer",this.mainPlayer.uid);this.renderer=s;for(let l=-2;l<=2;++l)for(let c=-2;c<=2;++c)for(let u=2;u>=-2;--u)this.loadChunk(l,u,c);this.fluidCalculator=new Ti(this),this.lightingCalculator=new mi(this),this.setRenderer(s),this.tickTimerId=null,this.lastTickTimestamp=performance.now(),this.beforeTick()}saveEntities(){this.storager.set("entities",this.entities.map(t=>t.toObj()))}setRenderer(t=null){if(t===this.renderer)return this;const i=this.renderer;if(this.renderer=t,i){i.setWorld();for(let s in this.chunkMap)this.chunkMap[s].setRenderer()}if(!t)return this;for(let s in this.chunkMap)this.chunkMap[s].setRenderer(t);return this}getChunkByChunkKey(t){return this.chunkMap[t]||null}getChunkByChunkXYZ(t,i,s){return this.getChunkByChunkKey(L.chunkKeyByChunkXYZ(t,i,s))}getChunkByBlockXYZ(t,i,s){return this.getChunkByChunkKey(L.chunkKeyByBlockXYZ(t,i,s))}loadChunk(t,i,s){let n=L.chunkKeyByChunkXYZ(t,i,s),a=this.chunkMap[n];return a||(a=this.chunkMap[n]=new L(this,t,i,s),this.dispatchEvent("onChunkLoad",a),a)}getTile(t,i,s){[t,i,s]=[t,i,s].map(Math.floor);let n=this.chunkMap[L.chunkKeyByBlockXYZ(t,i,s)];return n?n.getTile(...L.getRelativeBlockXYZ(t,i,s)):null}setTile(t,i,s,n,a){[t,i,s]=[t,i,s].map(Math.floor);let h=this.chunkMap[L.chunkKeyByBlockXYZ(t,i,s)];if(h){let l=h.setTile(...L.getRelativeBlockXYZ(t,i,s),n,a);return this.dispatchEvent("onTileChanges",t,i,s),l}return null}getBlock(t,i,s){[t,i,s]=[t,i,s].map(Math.floor);let n=this.chunkMap[L.chunkKeyByBlockXYZ(t,i,s)];return n?n.getBlock(...L.getRelativeBlockXYZ(t,i,s)):null}setBlock(t,i,s,n){[t,i,s]=[t,i,s].map(Math.floor);let a=this.chunkMap[L.chunkKeyByBlockXYZ(t,i,s)];if(a){let h=L.getRelativeBlockXYZ(t,i,s),l=a.setBlock(...h,n),c=this.storager.get("chunks>"+a.chunkKey,{});return c[L.getLinearBlockIndex(...h)]=this.getTile(t,i,s),this.storager.set("chunks>"+a.chunkKey,c),this.saveEntities(),this.dispatchEvent("onTileChanges",t,i,s),l}return null}getLight(t,i,s){[t,i,s]=[t,i,s].map(Math.floor);let n=this.chunkMap[L.chunkKeyByBlockXYZ(t,i,s)];return n?n.getLight(...L.getRelativeBlockXYZ(t,i,s)):null}getSkylight(t,i,s){[t,i,s]=[t,i,s].map(Math.floor);let n=this.chunkMap[L.chunkKeyByBlockXYZ(t,i,s)];return n?n.getSkylight(...L.getRelativeBlockXYZ(t,i,s)):null}getTorchlight(t,i,s){[t,i,s]=[t,i,s].map(Math.floor);let n=this.chunkMap[L.chunkKeyByBlockXYZ(t,i,s)];return n?n.getTorchlight(...L.getRelativeBlockXYZ(t,i,s)):null}onRender(t,i){var c,u;for(let p in this.chunkMap)this.chunkMap[p].onRender(t,i);this.fluidCalculator.onRender(t,i),this.lightingCalculator.onRender(t,i),this.entities.forEach(p=>p.onRender(t,i));const{mainPlayer:s}=this;if(U.showDebugOutput){const p=((u=(c=s.controller).getHitting)==null?void 0:u.call(c))??null;let f=p?this.getBlock(...p.blockPos):null,m=p?this.getTile(...p.blockPos):null,d=this.getChunkByBlockXYZ(...[...s.position].map(g=>g<0?g-1:g));this.fpss||(this.fpss=[]),this.fpss.push(i),this.fpss.length>15&&this.fpss.shift(),document.getElementsByTagName("mcpage-play")[0].debugOutput.style.display=null,document.getElementsByTagName("mcpage-play")[0].debugOutput.innerHTML=Object.entries({"FPS: ":(1e3/(this.fpss.reduce((g,y)=>g+y,0)/this.fpss.length)).toFixed(2),"Player:":["XYZ: "+[...s.position].map(g=>g.toFixed(1)).join(", "),`Pitch: ${pt(s.pitch).toFixed(2)}°, Yaw: ${Math.abs(pt(s.yaw)*100%36e3/100).toFixed(2)}°`,`Chunk: ${d?L.getRelativeBlockXYZ(...s.position).map(g=>~~g).join(" ")+" in "+[d.x,d.y,d.z].join(" "):"null"}`,`Light: ${this.getLight(...s.position)} (${this.getSkylight(...s.position)} sky, ${this.getTorchlight(...s.position)} block)`],"Crosshairs:":[`XYZ: ${p?p.blockPos.join(" "):"null"} (${p?L.getRelativeBlockXYZ(...p.blockPos).join(" "):"null"}/${p?L.getLinearBlockIndex(...L.getRelativeBlockXYZ(...p.blockPos)):"null"} in ${p?L.getChunkXYZByBlockXYZ(...p.blockPos).join(" "):"null"}, ${p?p.axis?p.axis:"in block":"null"})`,`Block: ${f?f.name:"null"} (${(m==null?void 0:m.id)??"null"}, ${(m==null?void 0:m.bd)??"null"}, ${m||"null"})`,`Face: ${(f==null?void 0:f.renderType)===C.renderType.FLOWER?"flower face":(p==null?void 0:p.axis)??"null"}, light: ${p?this.getLight(...I.add(p.blockPos,{"x+":[1,0,0],"x-":[-1,0,0],"y+":[0,1,0],"y-":[0,-1,0],"z+":[0,0,1],"z-":[0,0,-1]}[p.axis]||[0,0,0],[])):"null"} (${p?this.getSkylight(...I.add(p.blockPos,{"x+":[1,0,0],"x-":[-1,0,0],"y+":[0,1,0],"y-":[0,-1,0],"z+":[0,0,1],"z-":[0,0,-1]}[p.axis]||[0,0,0],[])):"null"} sky, ${p?this.getTorchlight(...I.add(p.blockPos,{"x+":[1,0,0],"x-":[-1,0,0],"y+":[0,1,0],"y-":[0,-1,0],"z+":[0,0,1],"z-":[0,0,-1]}[p.axis]||[0,0,0],[])):"null"} block)`]}).map(([g,y])=>`<p>${g}${Array.isArray(y)?y.map(v=>`<p>	${v}</p>`).join(""):y}</p>`).join("")}else document.getElementsByTagName("mcpage-play")[0].debugOutput.style.display="none";let n=L.getChunkXYZByBlockXYZ(...s.position),[a,h,l]=n;if(I.exactEquals(n,s.lastChunk||[]))for(let p=-1;p<=1;++p)for(let f=-1;f<=1;++f)for(let m=1;m>=-1;--m)this.loadChunk(a+p,h+m,l+f);s.lastChunk=n}onTick(){for(let t in this.chunkMap)this.chunkMap[t].onTick();this.fluidCalculator.onTick(),this.lightingCalculator.onTick(),this.entities.forEach(t=>t.onTick()),Date.now()-(this.lastEntitiesSaveTime||0)>2e4&&(this.lastEntitiesSaveTime=Date.now(),this.saveEntities())}rayTraceBlock(t,i,s){if(t.some(Number.isNaN)||i.some(Number.isNaN)||I.equals(t,i))return null;if(s(...t.map(Math.floor)))return{axis:"",blockPos:t.map(Math.floor)};let n=I.subtract(i,t,i),a=I.length(n),h=I.create(),l=I.create(),c=I.create(),u=I.create();n.forEach((p,f)=>{let m=h[f]=a/Math.abs(p);l[f]=p<0?-1:1,c[f]=p>0?Math.ceil(t[f])-1:Math.floor(t[f]),u[f]=m===1/0?1/0:m*(p>0?Math.ceil(t[f])-t[f]:t[f]-Math.floor(t[f]))});for(let p=0,f;p<=a&&(f=u[0]<u[1]&&u[0]<u[2]?0:u[1]<u[2]?1:2,p=u[f],!(p>a));){if(c[f]+=l[f],s(...c))return{axis:"xyz"[f]+(l[f]>0?"-":"+"),blockPos:c};u[f]+=h[f]}return null}hitboxesCollision(t,i,s){let n=I.length(i);if(n===0)return null;let a=t.min,h=t.max,l=I.create(),c=I.create(),u=I.create(),p=i.map(d=>d>0?1:-1),f=i.map(d=>n/Math.abs(d)),m=I.create();for(let d=0,g,y;d<3;d++)i[d]>0?(l[d]=h[d],y=a[d],u[d]=Math.floor(y),c[d]=Math.ceil(l[d])-1,g=Math.ceil(l[d])-l[d]):(l[d]=a[d],y=h[d],u[d]=Math.ceil(y)-1,c[d]=Math.floor(l[d]),g=l[d]-Math.floor(l[d])),m[d]=f[d]===1/0?1/0:f[d]*g;for(let d=0,g;d<=n&&(g=m[1]<m[0]&&m[1]<m[2]?1:m[0]<m[2]?0:2,d=m[g],!(d>n));){m[g]+=f[g],c[g]+=p[g],u[g]+=p[g];let[y,v,w]=p,E=g===0?c[0]:u[0],A=g===1?c[1]:u[1],k=g===2?c[2]:u[2],[T,b,B]=I.add(c,p),x,M,S;for(x=E;x!==T;x+=y)for(M=A;M!==b;M+=v)for(S=k;S!==B;S+=w)if(s(x,M,S))return{axis:g,step:p[g],pos:l[g]+d*(i[g]/n)}}return null}dispose(){}}const{X_SIZE:Ei,Y_SIZE:Bi,Z_SIZE:xi,getRelativeBlockXYZ:Ci,getLinearBlockIndex:xt}=L,ki=Array(16).fill(0).map((r,e)=>Math.pow(.9,15-e)),Ge=r=>ki[r],Ie=(r,e,t=1,i=Ge)=>{r*=4;let s=new Array(r),n=i(e)*t;for(let a=0;a<r;a+=4)s[a]=s[a+1]=s[a+2]=n,s[a+3]=1;return s},Ai=r=>{for(let e in r)return!1;return!0},Mi=[[1,0,0,"x+"],[-1,0,0,"x-"],[0,1,0,"y+"],[0,-1,0,"y-"],[0,0,1,"z+"],[0,0,-1,"z-"]];class Li{constructor(e=null){this.setWorld(e)}setWorld(e=null){this.world!==e&&(this.world&&(this.blockFaceCache={}),this.world=e,e&&(this.blockFaceCache={}))}updateChunkColor(e){const{chunkKey:t}=e,i=this.blockFaceCache[t];if(i)for(let s=0;s<Bi;++s)for(let n=0;n<xi;++n)for(let a=0;a<Ei;++a){if(!(xt(a,s,n)in i))continue;const[l,c,u]=e.blockRXYZ2BlockXYZ(a,s,n);this.gen(l,c,u,{chunk:e,crx:a,cry:s,crz:n,colorOnly:!0})}}gen(e,t,i,{chunk:s=(d=>(d=this.world)==null?void 0:d.getChunkByBlockXYZ(e,t,i))(),chunkKey:n=s==null?void 0:s.chunkKey,crx:a,cry:h,crz:l,cLongID:c,cblock:u,shade:p=U.shade,colorOnly:f=!1,justUpdateFaces:m=Mi}={}){if(s===null)return"";a===void 0&&([a,h,l]=Ci(e,t,i)),c===void 0&&(c=s.getTile(a,h,l),u=C.getBlockByBlockLongID(c));const g=this.blockFaceCache[n]||[];this.blockFaceCache[n]=g;const y=xt(a,h,l);if(u.name==="air"){let k=y in g;return delete g[y],k?"":n}const v=this.world||s.world,w=g[y]||{},E={y0:1,y1:1,y2:1,y3:1,average:1},A=k=>k.isFluid&&k===u||k.name==="flowing_"+u.name||"flowing_"+k.name===u.name;switch(u.renderType){case C.renderType.FLUID:if(!f&&c.bd<=u.maxLevel){const k=T=>T==-1?1:(u.maxLevel+1-T-.75)/(u.maxLevel+1);[[[-1,-1],[0,-1],[-1,0]],[[-1,0],[-1,1],[0,1]],[[1,0],[0,1],[1,1]],[[0,-1],[1,-1],[1,0]]].forEach((T,b)=>{let B=c.bd;for(const[x,M]of T){const S=v.getTile(e+x,t,i+M);if(S===null)continue;const P=S.bd,F=C.getBlockByBlockLongID(S);if(A(F)){if(P>u.maxLevel){B=-1;break}B=Math.min(B,P)}}E["y"+b]=k(B)})}case C.renderType.CACTUS:case C.renderType.NORMAL:{for(const[k,T,b,B]of m){if(f&&!(B in w))continue;let x=a+k,M=h+T,S=l+b,P=s.inOtherChunk(x,M,S),F=P?v.getBlock(e+k,t+T,i+b):s.getBlock(x,M,S);if(!f&&F&&(F.isOpaque||u.isGlass&&F.isGlass||u.isFluid&&A(F))){delete w[B];continue}let R=u.vertices[B].length/3,D=w[B]||{};w[B]=D;let _=P?v.getLight(e+k,t+T,i+b):s.getLight(x,M,S);_===null&&(_=15);let j=p?b?.8:k?.6:T==-1?.5:1:1;if(D.col=Ie(R,_,j),!f)if(u.isFluid?(delete D.disableCullFace,D.fluidSurface=!0):(delete D.fluidSurface,D.disableCullFace=u.renderType===C.renderType.CACTUS||u.isLeaves&&!(F&&F.isLeaves)),D.ele=u.elements[B],!u.isFluid)D.ver=u.vertices[B].map((X,N)=>N%3===0?X+e:N%3===1?X+t:X+i),D.tex=u.texture.uv[B];else{let X=u.vertices[B].map(ee=>E[ee]||ee),N=u.texture.uv[B];D.ver=X.map((ee,ue)=>ue%3===0?ee+e:ue%3===1?ee+t:ee+i),D.tex=T?N:u.texture.img.texture4array?[N[0],1-X[0*3+1],N[2],N[3],N[4],N[5],N[6],N[7],N[8],N[9],1-X[3*3+1],N[11]]:[N[0],N[4]-(N[4]-N[1])*X[0*3+1],N[2],N[3],N[4],N[5],N[6],N[7],N[8],N[9],N[7]-(N[7]-N[10])*X[3*3+1],N[11]]}}break}case C.renderType.FLOWER:{if(f){let x=s.getLight(a,h,l),M=u.vertices.face.length/3;w.face&&(w.face.col=Ie(M,x));break}let k=w.aroundOpaqueCounter||{};w.aroundOpaqueCounter=k;for(let[x,M,S,P]of m){let F=a+x,R=h+M,D=l+S,_=s.inOtherChunk(F,R,D)?v.getBlock(e+x,t+M,i+S):s.getBlock(F,R,D);k[P]=_&&_.isOpaque}let T=0;for(let x in k)T+=k[x];if(T===6){delete w.face;break}let b=s.getLight(a,h,l),B=u.vertices.face.length/3;w.face={disableCullFace:!0,ver:u.vertices.face.map((x,M)=>M%3===0?x+e:M%3===1?x+t:x+i),col:Ie(B,b),ele:u.elements.face,tex:u.texture.uv.face};break}}return Ai(w)?delete g[y]:g[y]=w,n}getMeshArrays(e,t=!1){if(!(e in this.blockFaceCache))return null;const i={},s={},n=(a,h,l)=>{a in i||(i[a]={}),h in i[a]||(i[a][h]=[]),i[a][h].push(...l)};return this.blockFaceCache[e].forEach(a=>{for(const h in a){const l=a[h];if("ele"in l){for(const c of["disableCullFace","fluidSurface","normal"])if(l[c]||c==="normal"){if(n(c,"col",l.col),!t){n(c,"ver",l.ver),n(c,"tex",l.tex);const u=l.ver.length/3,p=s[c]||0;s[c]=p+u,n(c,"ele",l.ele.map(f=>f+p))}break}}}}),i}dispose(){this.setWorld()}}class Ii{constructor(e,t){q(this,"onSettingsChange",(e,t)=>{if(this.world){if(e==="shade")for(let i in this.world.chunkMap)this.updateLight(i);this.onRender(),this.renderer.draw()}});this.meshes={},this.needUpdateMeshChunks=new Set,this.needUpdateColMeshChunks=new Set,this.needUpdateTile=new Set,this.setRenderer(t),this.setWorld(e),U.addEventListener("changedValue",this.onSettingsChange)}setWorld(e=null){if(this.world!==e&&(this.world&&this.blockModuleBuilder.dispose(),this.world=e,!!e)){this.blockModuleBuilder=new Li(e);for(let t in e.chunkMap)this.buildChunkModule(t);e.addEventListener("onTileChanges",this.updateTile.bind(this)),e.addEventListener("onChunkLoad",t=>{this.buildChunkModule(t.chunkKey);for(let[i,s,n]of[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]])this.buildChunkModule(L.chunkKeyByChunkXYZ(t.x+i,t.y+s,t.z+n))})}}setRenderer(e=null){this.renderer!==e&&(this.renderer&&(Object.values(this.meshes).forEach(t=>{for(let i of["ver","col","tex","ele"])this.renderer.delBo(t.normal[i]),this.renderer.delBo(t.disableCullFace[i]),this.renderer.delBo(t.fluidSurface[i])}),this.meshes={}),this.renderer=e,e&&(e.isWebGL2?e.createProgram("showBlock",gt.vert,gt.frag).use().bindTex("blockTex",e.createTextureArray(C.defaultBlockTextureImg)):e.createProgram("showBlock",mt.vert,mt.frag).use().bindTex("blockTex",e.createTexture(C.defaultBlockTextureImg)),this.updateMeshs()))}buildChunkModule(e){const t=this.world,i=t.getChunkByChunkKey(e);if(i!==null){for(let s=0;s<z;++s)for(let n=0;n<V;++n)for(let a=0;a<$;++a)this.blockModuleBuilder.gen(...i.blockRXYZ2BlockXYZ(a,s,n),{chunk:i,crx:a,cry:s,crz:n});i.updatedLightMap=!1,this.needUpdateMeshChunks.add(e)}}updateTile(e,t,i){this.needUpdateTile.add([e,t,i].join(","))}updateTiles(e=this.needUpdateTile){const{blockModuleBuilder:t,needUpdateMeshChunks:i}=this;e.forEach(s=>{const[n,a,h]=s.split(",").map(c=>+c),l=t.gen(n,a,h);for(const[c,u,p,f]of[[1,0,0,"x-"],[-1,0,0,"x+"],[0,1,0,"y-"],[0,-1,0,"y+"],[0,0,1,"z-"],[0,0,-1,"z+"]]){const m=n+c,d=a+u,g=h+p;if(e.has([m,d,g].join(",")))continue;const y=t.gen(m,d,g,{justUpdateFaces:[[-c,-u,-p,f]]});y&&i.add(y)}l&&i.add(l)}),e.clear()}updateLight(e){const t=this.world.getChunkByChunkKey(e);t&&(this.blockModuleBuilder.updateChunkColor(t),this.needUpdateColMeshChunks.add(e))}updateMeshs(){const{meshes:e,blockModuleBuilder:t,updateMesh:i}=this;for(let s in e)i(s,t.getMeshArrays(s))}updateMesh(e,t=null){if(t==null)return delete this.meshes[e];let i=this.meshes[e];i||(i=this.meshes[e]={});const{renderer:s}=this;for(const n of["disableCullFace","fluidSurface","normal"]){let a=i[n];if(!a){a=i[n]={};for(const l of["ver","col","tex","ele"])l=="ele"?a[l]=s.createIbo([]):a[l]=s.createVbo([])}const h=t[n];if(h)for(const l in h)s.bindBoData(a[l],h[l]);else for(const l in a)s.bindBoData(a[l],[])}}onRender(e,t){this.needUpdateTile.size&&this.updateTiles(this.needUpdateTile),Object.values(this.world.chunkMap).filter(i=>i.updatedLightMap).forEach(i=>{i.updatedLightMap=!1;const s=i.chunkKey;this.updateLight(s);for(let[n,a,h]of[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]])this.updateLight(L.chunkKeyByChunkXYZ(i.x+n,i.y+a,i.z+h))}),this.needUpdateColMeshChunks.size&&(this.needUpdateColMeshChunks.forEach(i=>{this.needUpdateMeshChunks.has(i)||this.updateMesh(i,this.blockModuleBuilder.getMeshArrays(i,!0))}),this.needUpdateColMeshChunks.clear()),this.needUpdateMeshChunks.size!==0&&(this.needUpdateMeshChunks.forEach(i=>{this.updateMesh(i,this.blockModuleBuilder.getMeshArrays(i))}),this.needUpdateMeshChunks.clear())}onTick(){}draw(){const{renderer:e}=this,{ctx:t}=e,i=e.getProgram("showBlock");i.use().setUni("mvMatrix",e.mainCamera.view).setUni("mvpMatrix",e.mainCamera.projview).setUni("fogColor",[.62,.81,1,1]).setUni("fogNear",48).setUni("fogFar",64);const s=this.world.mainPlayer;let n=this.world.getChunkByBlockXYZ(...[...s.position].map(h=>h<0?h-1:h));const a=Object.entries(this.meshes).map(([h,l])=>{const c=L.getChunkXYZByChunkKey(h);return{chunkKey:h,mesh:l,chunkPos:c,dis:ti(c,[n.x,n.y,n.z])}});a.sort((h,l)=>l.dis-h.dis);for(const{mesh:h}of a){let l=h.normal;l.ele.length&&(i.setAtt("position",l.ver).setAtt("color",l.col).setAtt("textureCoord",l.tex),t.bindBuffer(l.ele.type,l.ele),t.drawElements(t.TRIANGLES,l.ele.length,t.UNSIGNED_SHORT,0)),l=h.disableCullFace,l.ele.length&&(i.setAtt("position",l.ver).setAtt("color",l.col).setAtt("textureCoord",l.tex),t.disable(t.CULL_FACE),t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(1,1),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.bindBuffer(l.ele.type,l.ele),t.drawElements(t.TRIANGLES,l.ele.length,t.UNSIGNED_SHORT,0),t.blendFunc(t.ONE,t.ZERO),t.disable(t.BLEND),t.disable(t.POLYGON_OFFSET_FILL),t.enable(t.CULL_FACE))}for(const{mesh:h}of a){let l=h.fluidSurface;l.ele.length&&(i.setAtt("position",l.ver).setAtt("color",l.col).setAtt("textureCoord",l.tex),t.depthMask(!1),s.eyeInFluid&&t.disable(t.CULL_FACE),t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(1,1),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.bindBuffer(l.ele.type,l.ele),t.drawElements(t.TRIANGLES,l.ele.length,t.UNSIGNED_SHORT,0),t.blendFunc(t.ONE,t.ZERO),t.disable(t.BLEND),t.disable(t.POLYGON_OFFSET_FILL),s.eyeInFluid&&t.enable(t.CULL_FACE),t.depthMask(!0))}}dispose(){this.setRenderer(),this.blockModuleBuilder.dispose(),U.removeEventListener("changedValue",this.onSettingsChange)}}var $e,Ut;class Ri{constructor(e,t=e.renderer){te(this,$e);this.world=e,this.mvp=H.identity(),this.setRenderer(t)}setRenderer(e=null){e&&(this.renderer&&this.dispose(),this.renderer=e,e.createProgram("selector",vt.vert,vt.frag),Ne(this,$e,Ut).call(this))}draw(){var E,A;const{world:e}=this,{mainPlayer:t}=e;if(t.camera===null)return;const i=((A=(E=t.controller).getHitting)==null?void 0:A.call(E))??null;if(i===null)return;const{renderer:s}=this,{ctx:n}=s;let[a,h,l]=i.blockPos,c=e.getBlock(a,h,l),u=s.getProgram("selector").use(),p=[],f=[];H(this.mvp).E().translate(i.blockPos).postMul(t.camera.projview),u.setUni("mvp",this.mvp);let m=this.meshs.get(c.renderType),d=m.line,g=m.surface;switch(c.renderType){case C.renderType.FLUID:case C.renderType.CACTUS:case C.renderType.NORMAL:{if(!i.axis)break;let[k,T,b]={"x+":[1,0,0],"x-":[-1,0,0],"y+":[0,1,0],"y-":[0,-1,0],"z+":[0,0,1],"z-":[0,0,-1]}[i.axis],B=e.getLight(a+k,h+T,l+b),x=Math.min(1,Ge(B)+.1);p=[...Array(d.ver.length/3*4)].map((M,S)=>S%4===3?.4:x),f=[...Array(g[i.axis].ver.length/3*4)].map((M,S)=>S%4===3?.1:x);break}case C.renderType.FLOWER:{let k=e.getLight(a,h,l),T=Math.min(1,Ge(k)+.1);p=[...Array(d.ver.length/3*4)].map((b,B)=>B%4===3?.4:T),f=[...Array(g.face.ver.length/3*4)].map((b,B)=>B%4===3?.1:T);break}}let y=d.defaultCol;if(p.length&&(y=d.col,s.bindBoData(y,p,{drawType:n.DYNAMIC_DRAW})),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.bindBuffer(d.ele.type,d.ele),u.setAtt("pos",d.ver).setAtt("col",y),n.drawElements(n.LINES,d.ele.length,n.UNSIGNED_SHORT,0),n.disable(n.BLEND),!i.axis)return;let v=c.renderType===C.renderType.FLOWER?g.face:g[i.axis],w=v.col;s.bindBoData(w,f,{drawType:n.DYNAMIC_DRAW}),n.disable(n.CULL_FACE),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.enable(n.POLYGON_OFFSET_FILL),n.polygonOffset(-1,-1),n.depthMask(!1),n.bindBuffer(v.ele.type,v.ele),u.setAtt("pos",v.ver).setAtt("col",w),n.drawElements(n.TRIANGLES,v.ele.length,n.UNSIGNED_SHORT,0),n.depthMask(!0),n.disable(n.POLYGON_OFFSET_FILL),n.disable(n.BLEND),n.enable(n.CULL_FACE)}dispose(){const{ctx:e}=this.renderer;for(let[,t]of this.meshs){for(let i of["ver","ele","col"])e.deleteBuffer(t.line[i]),Object.values(t.surface).forEach(s=>e.deleteBuffer(s[i]));e.deleteBuffer(t.line.defaultCol)}}}$e=new WeakSet,Ut=function(){const{renderer:e}=this,{ctx:t}=this.renderer;this.meshs=new Map;for(let i of Object.values(C.renderType)){let s=i===C.renderType.FLUID;s&&(i=C.renderType.NORMAL);let n=C.getElementsByRenderType(i),a=[],h=C.getVerticesByRenderType(i),l={};for(let p in h)(i!==C.renderType.CACTUS||p!="y+"&&p!="y-")&&a.push(...h[p]),l[p]={ver:e.createVbo(h[p]),ele:e.createIbo(n[p]),col:e.createVbo([],t.DYNAMIC_DRAW)};let c=(p=>{if(!p)return[];let f=[0,1,1,2,2,3,3,0],m=[];for(let d=0,g=0;d<p;g=++d*4)m.push(...f.map(y=>y+g));return m})(a.length/12),u=[...Array(a.length/3*4)].map((p,f)=>f%4===3?.5:1);s&&(i=C.renderType.FLUID),this.meshs.set(i,{line:{ver:e.createVbo(a),ele:e.createIbo(c),defaultCol:e.createVbo(u),col:e.createVbo([],t.DYNAMIC_DRAW)},surface:l})}};const Ye=new Map;C.preloaded.then(()=>{const r=C.listBlocks();for(let e of r){const t=e.renderType,i=[],s=Ye.has(t)?null:!0,n=s&&{ver:[],ele:[],defaultTex:[],defaultCol:[]},a=s&&C.getTexUVByTexCoord({renderType:t});switch(t){case C.renderType.CACTUS:case C.renderType.NORMAL:{let h=0;for(let l in e.vertices){const c=e.vertices[l];n==null||n.ver.push(...c),n==null||n.ele.push(...e.elements[l].map(u=>u+h)),n==null||n.defaultTex.push(...a.uv[l]),i.push(...e.texture.uv[l]),h+=c.length/3}break}}n==null||n.defaultCol.push(...Ie(n.ver.length/3,15)),Ye.set(e,i),s&&Ye.set(t,n)}});const Je=new WeakMap;class Ct{constructor(e,t){this.entity=e,e.model=this,this.setRenderer(t),this.lastLight=-1,this.col=[],this.randomStart=Math.random()*360*36*540,this.mM=H.identity()}setRenderer(e=null){if(this.renderer===e||(this.renderer=e,this.bufferObj={},!e))return;if(!Je.has(e)){let n=new Map;for(let[a,h]of Ye)a instanceof C?n.set(a,e.createVbo(h)):n.set(a,{ver:e.createVbo(h.ver),ele:e.createIbo(h.ele),defaultTex:e.createVbo(h.defaultTex),defaultCol:e.createVbo(h.defaultCol)});Je.set(e,n)}const t=Je.get(e),i=C.getBlockByBlockLongID(this.entity.longID),s=t.get(i.renderType);this.bufferObj={ver:s.ver,ele:s.ele,tex:t.get(i)||s.defaultTex,col:e.createVbo([],e.ctx.DYNAMIC_DRAW)}}onRender(e,t){const i=this.entity.world.getLight(...this.entity.position);if(this.lastLight!=i){this.lastLight=i;const s=this.bufferObj.ver.length/3;this.col=Ie(s,i,n=>Math.min(1,Ge(n)+.06)),this.renderer.bindBoData(this.bufferObj.col,this.col,{drawType:this.renderer.ctx.DYNAMIC_DRAW})}this.randomStart+=t}onTick(){}draw(){if(!this.renderer)return;const{renderer:e,bufferObj:t,mM:i,entity:s}=this,{ctx:n}=e,a=e.getProgram("entityItem");H(i).E().translate(s.position).rotate(_t(this.randomStart/36),[0,1,0]).scale([.25,.25,.25]).translate([-.5,Math.sin(this.randomStart/540)*.5+1.125,-.5]),a.use().setUni("mMatrix",i).setUni("vMatrix",e.mainCamera.view).setUni("pMatrix",e.mainCamera.projection).setUni("fogColor",[.62,.81,1,1]).setUni("fogNear",48).setUni("fogFar",64).setAtt("position",t.ver).setAtt("color",t.col).setAtt("textureCoord",t.tex),n.bindBuffer(t.ele.type,t.ele),n.drawElements(n.TRIANGLES,t.ele.length,n.UNSIGNED_SHORT,0)}dispose(){this.setRenderer()}}class Si{constructor(e,t){q(this,"onAddEntity",e=>{e.isItem&&this.models.add(new Ct(e,this.renderer))});this.models=new Set,this.setRenderer(t),this.setWorld(e)}setWorld(e=null){if(this.world!==e){if(this.world){for(let t of this.models)t.dispose();this.world.removeEventListener("onAddEntity",this.onAddEntity)}if(this.world=e,this.models.clear(),!!e){for(let t of e.entities)t.isItem&&this.models.add(new Ct(t,this.renderer));e.addEventListener("onAddEntity",this.onAddEntity)}}}setRenderer(e=null){if(this.renderer!==e){if(this.renderer)for(let t of this.models)t.setRenderer();if(this.renderer=e,!!e){e.isWebGL2&&e.createProgram("entityItem",yt.vert,yt.frag).use().bindTex("blockTex",e.createTextureArray(C.defaultBlockTextureImg));for(let t of this.models)t.setRenderer(e)}}}onRender(e,t){for(let i of this.models)i.onRender(e,t)}onTick(){}draw(){for(let e of this.models)e.draw()}dispose(){this.setWorld()}}class _i extends ct{constructor(e,t=null){super(e),this.fitScreen(),new ResizeObserver(async s=>{await new Promise(n=>setTimeout(n,0)),this.fitScreen(),this.draw()}).observe(e);const{ctx:i}=this;i.clearColor(.62,.81,1,1),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL),i.enable(i.CULL_FACE),i.frontFace(i.CCW),this.mainCamera=new Q(this.aspectRatio,{fovy:U.fov,pitch:-90*Math.PI/180,position:[0,20,0]}),this.settingsListenerID=U.addEventListener("changedValue",(s,n)=>{s==="fov"&&(this.mainCamera.setFovy(n),this.draw())}),this.addCamera(this.mainCamera),t!==null&&this.setWorld(t)}setWorld(e=null){if(e===this.world)return;const t=this.world;return this.world=e,t&&(t.setRenderer(),this.mainCamera.bindEntity(),this.chunksModule.dispose(),this.blockHighlight.dispose(),this.entitiesPainter.dispose(),this.chunksModule=this.blockHighlight=this.entitiesPainter=null),e?(e.setRenderer(this),this.mainCamera.bindEntity(e.mainPlayer),this.chunksModule=new Ii(e,this),this.blockHighlight=new Ri(e,this),this.entitiesPainter=new Si(e,this),this):this}onRender(e,t){var i,s,n;(i=this.world)==null||i.onRender(e,t),(s=this.chunksModule)==null||s.onRender(e,t),(n=this.entitiesPainter)==null||n.onRender(e,t),this.draw()}draw(){var t,i,s;const{ctx:e}=this;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),(t=this.chunksModule)==null||t.draw(),(i=this.entitiesPainter)==null||i.draw(),(s=this.blockHighlight)==null||s.draw(),e.flush()}dispose(){super.dispose(),this.setWorld(),U.removeEventListenerByID(this.settingsListenerID)}}const kt=r=>new Promise(e=>window.setTimeout(e,r));class Di extends re{static get outdegree(){return["play"]}async onTransitionedToThis(e,t,i,...s){let n=this.shadowRoot.getElementById("gen-out");n.innerHTML="Generating terrain...",await kt(70);let a=new bi({...s[0]||{}});n.innerHTML="Ready to render...",await kt(70);let h=O.getPageByID("play").mainCanvas,l=new _i(h,a);O.dispatchEvent("load-terrain.loaded",{world:a,renderer:l}),this.close({world:a,renderer:l})}}Di.asyncLoadAndDefine();class Pi extends re{static get outdegree(){return["play","welcome","setting"]}onHistoryBack(){this.close()}onTransitionedFromThis(e){e=="welcome"&&this.close()}}Pi.asyncLoadAndDefine();class Fi extends be{constructor(e=null){super(),this.setEntity(e)}setEntity(e=null){if(e===this.entity)return this;const t=this.entity;return this.entity=e,t&&t.setController(this),e&&e.setController(this),this}dispose(){this.setEntity()}}const At=-32768,Mt=32767;class Ni extends Ft{get isItem(){return!0}constructor({hitboxes:e={min:[-.125,0,-.125],max:[.125,.25,.125]},age:t=At,health:i=5,pickupDelay:s=Mt,owner:n=null,thrower:a=null,count:h=64,longID:l=1,...c}={}){super(e,c),this.age=t,this.health=i,this.pickupDelay=s,this.owner=n,this.thrower=a,this.count=h,this.longID=l}onTick(){super.onTick(),this.health==0&&this.dispose(),this.age!=At&&(this.age<6e3?++this.age:this.dispose()),this.pickupDelay!=Mt&&this.pickupDelay>0&&--this.pickupDelay}dispose(){this.world}}class Ui extends Fi{constructor(t=null,{playPage:i=O.getPageByID("play"),canvas:s=i?i.mainCanvas:null,moveButtons:n=i?i.moveButtons:null,hotbarUI:a=i?i.hotbar:null,mousemoveSensitivity:h=U.mousemoveSensitivity}={}){super(t);q(this,"onHotbarUISelectBlock",t=>{this.entity.onHandItem=t.detail||C.getBlockByBlockName("air")});q(this,"onCloseInventory",t=>{this.requestPointerLock()});q(this,"onShowInventory",t=>{this.exitPointerLock()});this.mousemoveSensitivity=h,this.eventHandler=this.eventHandler.bind(this),this["pause=>play"]=this.requestPointerLock.bind(this),this["play=>pause"]=this.exitPointerLock.bind(this),this._locked=!1,this.showStopPage=!1,this.canvasLastTouchPos=this.canvasBeginTouch=this.canvasTouchTimer=null,this.canvasTouchMoveLen=0,this.canvasDestroying=!1,this.keys=[],this.hotbar=[],this.inventoryStore=C.listBlocks(),this.setPlayPage(i,{canvas:s,moveButtons:n,hotbarUI:a}),this.settingsListenerID=U.addEventListener("changedValue",(l,c)=>{l==="mousemoveSensitivity"&&(this.mousemoveSensitivity=c)})}setPlayPage(t=null,{canvas:i=t?t.mainCanvas:null,moveButtons:s=t?t.moveButtons:null,hotbarUI:n=t?t.hotbar:null}={}){if(this.playPage&&(this.hotbarUI.removeEventListener("selectBlock",this.onHotbarUISelectBlock),this.playPage.removeEventListener("closeInventory",this.onCloseInventory),this.playPage.removeEventListener("showInventory",this.onShowInventory),this.setCanvas(),this.setMoveBtns()),this.playPage=t,this.hotbarUI=n,this.setCanvas(i),this.setMoveBtns(s),this.hotbar=[],!t)return;t.inventory.clear();const a=this.inventoryStore;for(let h of a)t.inventory.appendItem(h);for(let h=0;h<n.length;++h)this.hotbar.push(a[h]),n.setItem(a[h],h);n.addEventListener("selectBlock",this.onHotbarUISelectBlock),t.addEventListener("closeInventory",this.onCloseInventory),t.addEventListener("showInventory",this.onShowInventory)}dispose(){super.dispose(),this.setPlayPage(),U.removeEventListenerByID(this.settingsListenerID)}get locked(){return window.isTouchDevice||this._locked}setCanvas(t=null){if(this.canvas){this.exitPointerLock();for(let i of["keydown","keyup","pointerlockchange"])this.docOfCanvas.removeEventListener(i,this.eventHandler);for(let i of["mousedown","mouseup","mousemove","wheel","touchstart","touchend","touchcancel","touchmove"])this.canvas.removeEventListener(i,this.eventHandler);this.canvasTouchTimer!==null&&window.clearTimeout(this.canvasTouchTimer),this.canvasTouchTimer=null,O.removeEventListener("pause=>play",this["pause=>play"]),O.removeEventListener("play=>pause",this["play=>pause"])}if(this.canvas=t,this.rootOfCanvas=this.docOfCanvas=null,!!t){this.docOfCanvas=t.ownerDocument,this.rootOfCanvas=t.getRootNode();for(let i of["keydown","keyup","pointerlockchange"])this.docOfCanvas.addEventListener(i,this.eventHandler);for(let i of["mousedown","mouseup","mousemove","wheel"])t.addEventListener(i,this.eventHandler,{passive:!0});if(window.isTouchDevice)for(let i of["touchstart","touchend","touchcancel","touchmove"])t.addEventListener(i,this.eventHandler);O.addEventListener("pause=>play",this["pause=>play"]),O.addEventListener("play=>pause",this["play=>pause"])}}setMoveBtns(t=null){if(this.moveBtns){for(let i of"up,left,down,right,jump,upleft,upright,flyup,flydown,fly,sneak".split(","))this.moveBtns.removeEventListener(i+"BtnPress",this.eventHandler),this.moveBtns.removeEventListener(i+"BtnUp",this.eventHandler);this.moveBtns.removeEventListener("flyBtnDblPress",this.eventHandler)}if(this.moveBtns=t,!!t){for(let[i,s]of[["up",["w"]],["left",["a"]],["down",["s"]],["right",["d"]],["jump",[" "]],["upleft",["w","a"]],["upright",["w","d"]],["flyup",[" "]],["flydown",["Shift"]]])this[i+"BtnPress"]=()=>{s.forEach(n=>this.dispatchKeyEvent("down",n))},this[i+"BtnUp"]=()=>{for(let n=s.length-1;n>=0;--n)this.dispatchKeyEvent("up",s[n])},this.moveBtns.addEventListener(i+"BtnPress",this.eventHandler),this.moveBtns.addEventListener(i+"BtnUp",this.eventHandler);this.flyBtnDblPress=()=>{this.entity.toFlyMode&&this.entity.toFlyMode(!1);const{moveBtns:i}=this;i.activeFlyBtn(!1)},this.moveBtns.addEventListener("flyBtnDblPress",this.eventHandler)}}requestPointerLock(){!this.canvas||window.isTouchDevice||this.canvas.requestPointerLock()}exitPointerLock(){this.canvas===null||window.isTouchDevice||this.docOfCanvas.exitPointerLock()}eventHandler(t){if(!this.entity)return;const{type:i}=t;i in this&&this[i](t),this.dispatchEvent(i,t)}getHitting(t=[C.renderType.NORMAL,C.renderType.FLOWER,C.renderType.CACTUS]){let i=this.entity,s=i.world,n=i.getEyePosition(),a=i.getDirection(20);return I.add(n,a,a),s.rayTraceBlock(n,a,(h,l,c)=>{let u=s.getBlock(h,l,c);return u&&u.name!=="air"&&t.includes(u.renderType)})}_setEntityPitchAndYaw(t,i){let s=this.mousemoveSensitivity*(Math.PI/180);this.entity.yaw-=t*s/this.canvas.width,this.entity.pitch-=i*s/this.canvas.height,this.entity.pitch>Math.PI/2?this.entity.pitch=Math.PI/2:this.entity.pitch<-Math.PI/2&&(this.entity.pitch=-Math.PI/2)}mousemove(t){this.locked&&this._setEntityPitchAndYaw(t.movementX||t.mozMovementX||t.webkitMovementX||0,t.movementY||t.mozMovementY||t.webkitMovementY||0)}mousedown(t){if(!this.locked){this.requestPointerLock();return}if(t.button!==0&&t.button!==2)return;t.button===0&&(this.mouseRightBtnDown=!0),t.button===2&&(this.mouseLeftBtnDown=!0);const i=()=>{const s=this.entity.world,n=this.getHitting();if(n===null||n.axis==="")return;let a=n.blockPos;if(this.mouseLeftBtnDown){a["xyz".indexOf(n.axis[0])]+=n.axis[1]==="-"?-1:1;let h=this.entity.getGloBox();if(h.min=h.min.map(c=>Math.floor(c)),h.max=h.max.map(c=>Math.ceil(c)),a[0]>=h.min[0]&&a[1]>=h.min[1]&&a[2]>=h.min[2]&&a[0]<h.max[0]&&a[1]<h.max[1]&&a[2]<h.max[2])return;let l=this.entity.onHandItem.name;l!=="air"&&s.setBlock(...a,l)}else this.mouseRightBtnDown&&s.setBlock(...a,"air")};i(),this.destroyOrPlaceBlockTimer!==null&&window.clearInterval(this.destroyOrPlaceBlockTimer),this.destroyOrPlaceBlockTimer=window.setInterval(i,300)}mouseup(t){this.locked&&(t.button===0&&(this.mouseRightBtnDown=!1),t.button===2&&(this.mouseLeftBtnDown=!1),!(this.mouseRightBtnDown||this.mouseLeftBtnDown)&&this.destroyOrPlaceBlockTimer!==null&&(window.clearInterval(this.destroyOrPlaceBlockTimer),this.destroyOrPlaceBlockTimer=null))}keydown(t){if(this.locked&&(t.cancelable&&t.preventDefault(),!t.repeat)){if(t.key=="Q"||t.key=="q"){let i=new Ni({thrower:this.entity,longID:this.entity.onHandItem.longID,position:this.entity.position,world:this.entity.world});this.entity.world.entities.push(i),this.entity.world.dispatchEvent("onAddEntity",i)}(t.key=="E"||t.key=="e")&&(this.locked?(this.showStopPage=!1,this.playPage.showInventory()):this.playPage.closeInventory()),window.isTouchDevice?t.repeat!==!0&&(t.keyCode&&(this.keys[t.keyCode]=(this.keys[t.keyCode]||0)+1),this.keys[t.key]=this.keys[t.code]=(this.keys[t.key]||0)+1):(t.keyCode&&(this.keys[t.keyCode]=!0),this.keys[t.key]=this.keys[t.code]=!0),t.key==" "&&(this.spaceDownTime===0?this.spaceDownTime=new Date:new Date-this.spaceDownTime<300?(this.entity.toFlyMode&&this.entity.toFlyMode(!this.entity.isFly),this.moveBtns.activeFlyBtn(this.entity.isFly),this.spaceDownTime=0):this.spaceDownTime=new Date),t.code=="KeyW"&&(this.moveDownTime===0?this.moveDownTime=new Date:new Date-this.moveDownTime<300?(this.entity.toRunMode&&this.entity.toRunMode(!this.entity.isRun),this.moveDownTime=0):this.moveDownTime=new Date),this.entity.vertMoveDir=(this.keys.Space||0)-(this.keys.Shift||this.keys.KeyX||0),this.entity.horiMoveDir=[(this.keys.KeyD||0)-(this.keys.KeyA||0),(this.keys.KeyW||0)-(this.keys.KeyS||0)]}}keyup(t){this.locked&&(t.cancelable&&t.preventDefault(),window.isTouchDevice?(t.keyCode&&(this.keys[t.keyCode]=(this.keys[t.keyCode]||1)-1),this.keys[t.key]=this.keys[t.code]=(this.keys[t.key]||1)-1):(t.keyCode&&(this.keys[t.keyCode]=!1),this.keys[t.key]=this.keys[t.code]=!1),this.keys.KeyW||this.entity.toRunMode&&this.entity.toRunMode(!1),this.entity.vertMoveDir=(this.keys.Space||0)-(this.keys.Shift||this.keys.KeyX||0),this.entity.horiMoveDir=[(this.keys.KeyD||0)-(this.keys.KeyA||0),(this.keys.KeyW||0)-(this.keys.KeyS||0)])}wheel(t){if(!this.locked)return;const i=new Date;i-this.lastWeelTime<5||(t.deltaY<0?this.hotbarUI.selectNext():t.deltaY>0&&this.hotbarUI.selectPrev(),this.lastWeelTime=i)}pointerlockchange(t){let i=this.rootOfCanvas.pointerLockElement===this.canvas;this.locked!==i&&(!i&&this.showStopPage&&O.openPageByID("pause"),this.showStopPage=!0,this._locked=i)}dispatchMouseEventByTouchEvt(t,i,{button:s=0,buttons:n=s,movementX:a=0,movementY:h=0}={}){this.canvas.dispatchEvent(new MouseEvent("mouse"+t,{bubbles:!0,cancelable:!0,relatedTarget:this.canvas,screenX:i.changedTouches[0].screenX,screenY:i.changedTouches[0].screenY,clientX:i.changedTouches[0].clientX,clientY:i.changedTouches[0].clientY,...t!=="move"?{button:s,buttons:n}:{movementX:a,movementY:h}}))}touchstart(t){t.cancelable&&t.preventDefault(),this.canvasLastTouchPos=this.canvasBeginTouch=t,this.canvasTouchMoveLen=0,this.canvasDestroying=!1,this.canvasTouchTimer!==null&&window.clearTimeout(this.canvasTouchTimer),this.canvasTouchTimer=window.setTimeout(()=>{this.canvasTouchMoveLen<10&&(this.canvasDestroying=!0,this.dispatchMouseEventByTouchEvt("down",this.canvasLastTouchPos)),this.canvasTouchTimer=null},300)}get touchcancel(){return this.touchend}touchend(t){t.cancelable&&t.preventDefault(),t.timeStamp-this.canvasBeginTouch.timeStamp<150?(this.dispatchMouseEventByTouchEvt("down",t,{button:2}),this.dispatchMouseEventByTouchEvt("up",t,{button:2})):this.canvasDestroying&&this.dispatchMouseEventByTouchEvt("up",t),this.canvasTouchTimer!==null&&window.clearTimeout(this.canvasTouchTimer),this.canvasLastTouchPos=null}touchmove(t){if(t.cancelable&&t.preventDefault(),!this.canvasLastTouchPos){this.canvasLastTouchPos=t;return}let i=t.targetTouches[0].screenX-this.canvasLastTouchPos.targetTouches[0].screenX,s=t.targetTouches[0].screenY-this.canvasLastTouchPos.targetTouches[0].screenY;this.canvasTouchMoveLen+=Math.sqrt(i**2+s**2);let n=this.canvas.width/this.canvas.height;i*=n*2.5,s*=2.5,this._setEntityPitchAndYaw(i,s),this.canvasLastTouchPos=t}dispatchKeyEvent(t,i,s={" ":"Space",Shift:"ShiftLeft"}[i]||"Key"+i.toUpperCase(),n=i=="Shift"?16:i.toUpperCase().charCodeAt(0),a=!1){this.docOfCanvas.dispatchEvent(new KeyboardEvent("key"+t,{bubbles:!0,cancelable:!0,key:i,code:s,keyCode:n,repeat:a,which:n}))}}class Ot extends re{static get outdegree(){return["load-terrain","pause"]}constructor(){super(),this.moveButtons=this.shadowRoot.querySelector("mc-move-buttons"),this.inventory=this.shadowRoot.querySelector("mc-inventory"),this.hotbar=this.shadowRoot.querySelector("mc-hotbar"),this.mainCanvas=this.shadowRoot.getElementById("mainCanvas"),this.debugOutput=this.shadowRoot.getElementById("mc-f3-out"),this.world=this.worldRenderer=null}onConnected(){this.hotbar.addEventListener("inventoryBtnClick",e=>{this.isShownInventory?this.closeInventory():this.showInventory()}),this.inventory.addEventListener("closeBtnClick",e=>{this.closeInventory()}),this.inventory.addEventListener("inventoryItemClick",e=>{this.hotbar.setItem(e.detail),this.hotbar.showName()}),window.isTouchDevice?this.hotbar.setAttribute("showInventoryBtn",""):this.moveButtons.style.display="none",this.playerLocalController=new Ui(null,{playPage:this})}dispose(){this.worldRenderer&&(this.worldRenderer.dispose(),this.playerLocalController.dispose(),this.world=this.worldRenderer=null)}onDisconnected(){this.dispose()}onTransitionedFromThis(e,t,i,...s){e=="pause"&&this.worldRenderer.stop()}onTransitionedToThis(e,t,i,...s){switch(e){case"select-world":case"create-new-world":{O.openPageByID("load-terrain",s[0]);break}case"load-terrain":{this.dispose();const[{world:n,renderer:a}]=s;this.world=n,this.worldRenderer=a,this.playerLocalController.setPlayPage(this),this.playerLocalController.setEntity(n.mainPlayer),a.play(),O.openPageByID("pause");break}case"pause":{this.worldRenderer.play();break}}}get isShownInventory(){return this.inventory.style.display!=="none"}showInventory(){this.inventory.style.display="",this.hotbar.activeInventoryBtn(!0),this.dispatchEvent(new Event("showInventory"))}closeInventory(){this.inventory.style.display="none",this.hotbar.activeInventoryBtn(!1),this.dispatchEvent(new Event("closeInventory"))}onTransitioned(e,t,i,s,n,...a){t=="welcome"&&this.close()}}const Wt=r=>O.openPageByID("pause");O.addEventListener("onfullscreenchange",r=>{window.isTouchDevice&&!r&&O.getCurrentPage().pageID===Ot.pageID&&(window.removeEventListener("back",Wt),O.openPageByID("pause"))});O.addEventListener("pause=>play",(r,e)=>{window.addEventListener("back",Wt,{once:!0})});Ot.asyncLoadAndDefine();class Oi extends re{static get outdegree(){return["select-world","play"]}constructor(){super(),this.typeBtn=this.shadowRoot.getElementById("world-type-btn"),this.typeEcho=this.shadowRoot.getElementById("world-type-echo"),this.createBtn=this.shadowRoot.getElementById("create-new-word"),this.worldName=this.shadowRoot.getElementById("world-name"),this.worldSeed=this.shadowRoot.getElementById("world-seed"),this.typeBtn.addEventListener("click",()=>{this.typeEcho.innerHTML=="Normal"?this.typeEcho.innerHTML="Flat":this.typeEcho.innerHTML="Normal"}),this.createBtn.addEventListener("click",()=>{let e=this.worldSeed.value;e!==""&&!Number.isNaN(+e)&&(e=+e),O.openPageByID("play",{worldName:this.worldName.value,worldType:{Normal:"pre-classic",Flat:"flat"}[this.typeEcho.innerHTML],seed:e})})}onHistoryBack(){this.close()}onTransitioned(e,t,i,s,n,...a){t=="play"&&this.close()}}Oi.asyncLoadAndDefine();class me extends ne{constructor(){super(),this.addEventListener("click",e=>{if(this.disabled&&e.cancelable&&e.stopPropagation(),!this.hasAttribute("gotoPage"))return!1;let t=this.getAttribute("gotoPage");O.openPageByID(t)},!0)}static get observedAttributes(){return["disabled","value"]}onAttrChanged(e,t,i){e=="value"?this.shadowRoot.querySelector("slot").innerHTML=i:e==="disabled"&&(this.disabled=i!==null)}get disabled(){return this.hasAttribute("disabled")}set disabled(e){e?this.setAttribute("disabled",""):this.removeAttribute("disabled")}}me.setBorderAndWaitImg("button",":host");me.setBorderAndWaitImg("button-hover",":host(:hover)");me.setBorderAndWaitImg("button-active",":host(:active)");me.setBorderAndWaitImg("button-disabled",":host([disabled])");me.asyncLoadAndDefine();const Lt=(r,e)=>(r+e)%e;class Ee extends ne{constructor(){super(),this.itemsDOM=this.shadowRoot.getElementById("items"),this.shownameBox=this.shadowRoot.querySelector(".showname"),this.inventoryBtn=this.shadowRoot.querySelector(".inventory-btn"),this.inventoryBtn.addEventListener("click",e=>(e.preventDefault(),this.dispatchEvent(new Event("inventoryBtnClick")),!1)),this.length=9,this.blocks=[];for(let e=0;e<this.length;++e){let t=document.createElement("img");t.onclick=i=>this.updateSelector(e),t.draggable=!1,this.itemsDOM.append(t)}}get selectOn(){return 1*getComputedStyle(this).getPropertyValue("--offset")}onConnected(){let e=this.hasAttribute("showInventoryBtn")||window.isTouchDevice;this.inventoryBtn.style.display=e?"":"none"}static get observedAttributes(){return["offset","inventory_btn_active"]}onAttrChanged(e,t,i){switch(e){case"inventory_btn_active":{this.activeInventoryBtn(this.hasAttribute(e));break}case"offset":{this.style.setProperty("--offset",i);break}}}activeInventoryBtn(e){e?(this.inventoryBtn.setAttribute("active",""),this.hasAttribute("inventory_btn_active")||this.setAttribute("inventory_btn_active","")):(this.inventoryBtn.removeAttribute("active"),this.hasAttribute("inventory_btn_active")&&this.removeAttribute("inventory_btn_active"))}updateSelector(e=this.selectOn){e=Lt(e,this.length),this.style.setProperty("--offset",e),this.showName(),this.dispatchEvent("selectBlock",{global:!0,data:this.blocks[e]})}setItem(e,t=this.selectOn){t=Lt(t,this.length);const{blocks:i,itemsDOM:s}=this;i[t]=e,s.innerHTML="";for(let n=0;n<this.length;++n){let a=i[n],h=a?a.texture.inventory.cloneNode():document.createElement("img");h.draggable=!1,h.onclick=l=>this.updateSelector(n),s.append(h)}this.updateSelector()}getSelectedItem(e=this.selectOn){return this.blocks[e]}selectPrev(){this.updateSelector(this.selectOn+1)}selectNext(){this.updateSelector(this.selectOn-1)}showName(e=this.selectOn){const t=this.blocks[e];if(!t||t.name=="air")return;const i=this.shownameBox;i.innerHTML=t.showName,i.classList.remove("fadeout"),setTimeout(()=>{i.classList.add("fadeout")},10)}}Ee.setBackgroundAndWaitImg("hotbar-background",".hotbar-background");Ee.setBackgroundAndWaitImg("hotbar-selector-background",".selector-background");Ee.setBackgroundAndWaitImg("hotbar-inventory-btn-foreground",".inventory-btn > .foreground");Ee.setBorderAndWaitImg("hotbar-inventory-btn-bg",".inventory-btn > .background");Ee.setBorderAndWaitImg("hotbar-inventory-btn-bg-active",".inventory-btn[active] > .background, .inventory-btn > .background[active]");Ee.asyncLoadAndDefine();class Wi extends ne{get template(){return ne.genTemplate(`
            <style>
                :host {
                    background-image: url(texture/icons.png);
                    background-size: 100% 100%;
                    background-repeat: no-repeat;
                    pointer-events: none;
                    display: block;
                    width: 32px; height: 32px;
                    margin: auto auto;
                    position: absolute;
                    left: 0; top: 0;
                    bottom: 0; right: 0;
                }
            </style>
        `)}}Wi.define();const Xi=document.body.requestFullscreen||document.body.mozRequestFullScreen||document.body.webkitRequestFullScreen||document.body.msRequestFullscreen,Xt=()=>document.body===(document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement);document.body.onfullscreenchange=document.body.onmozfullscreenchange=document.body.onwebkitfullscreenchange=document.body.MSFullscreenChange=function(r){if(r.target===null)return;const e=Xt();O.dispatchEvent("onfullscreenchange",e)};class Hi extends me{static get templateUrlFilename(){return"MCButton"}constructor(){super(),this.onfullscreenchange=this.onfullscreenchange.bind(this),this.onclick=this.onclick.bind(this),O.addEventListener("onfullscreenchange",this.onfullscreenchange),this.addEventListener("click",this.onclick)}onfullscreenchange(e){this.style.display=e?"none":""}onConnected(){this.innerHTML="full screen",this.style.position="absolute",this.style.top=this.style.right="10px",this.style.display=window.isTouchDevice&&!Xt()?"":"none"}onDisconnected(){O.removeEventListener("onfullscreenchange",this.onfullscreenchange),this.removeEventListener("click",this.onclick)}onclick(){Xi.call(document.body).then(async e=>{try{await screen.orientation.lock("landscape")}catch(i){console.warn(i);let s=screen.lockOrientation||screen.mozLockOrientation||screen.msLockOrientation;s&&s.call(screen,"landscape")}if(await new Promise(i=>setTimeout(i,200)),["landscape-primary","landscape-secondary","landscape"].includes(screen.orientation.type))return;document.documentElement.onfullscreenchange=document.documentElement.onmozfullscreenchange=document.documentElement.onwebkitfullscreenchange=document.documentElement.MSFullscreenChange=null,(document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen).call(document),this.style.display="none"},e=>{console.warn(e)})}}customElements.whenDefined(me.componentName).then(r=>Hi.define());class Be extends ne{constructor(){super(),this.closeBtn=this.shadowRoot.querySelector(".mc-close-btn"),this.closeBtn.addEventListener("click",e=>(e.preventDefault(),this.dispatchEvent(new Event("closeBtnClick")),!1)),this.itemList=this.shadowRoot.querySelector(".mc-inventory-items")}appendItem(e){let t=document.createElement("div");t.classList="mc-inventory-item-background",t.appendChild(e.texture.inventory.cloneNode()).draggable=!1,t.data=e,t.onclick=i=>(i.preventDefault(),this.dispatchEvent("inventoryItemClick",{global:!0,data:e}),!1),this.itemList.append(t)}clear(){this.itemList.innerHTML=""}}Be.setBorderAndWaitImg("inventory-items",".mc-inventory-items");Be.setBorderAndWaitImg("inventory-tab-background-right",".mc-inventory-tab-background-right");Be.setBackgroundAndWaitImg("close-btn",".mc-close-btn");Be.setBackgroundAndWaitImg("close-btn-active",".mc-close-btn:active");Be.setBackgroundAndWaitImg("inventory-item-background",".mc-inventory-item-background");Be.asyncLoadAndDefine();class rt extends ne{static get templateUrlFilename(){return"MCMoveBtns"}constructor(){super(),this.lastBtnPressTime={},this.isPress={},this.btns=[];for(let e of"up,left,down,right,jump,upleft,upright,flyup,flydown,fly,sneak".split(","))this[e]=this.btns[e]=this.shadowRoot.getElementById(e),this.lastBtnPressTime[e]=0,this.isPress[e]=!1,this.btns.push(this[e]);this.onTouchMove=this.onTouchMove.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.addEventListener("touchstart",this.onTouchMove),this.addEventListener("touchend",this.onTouchEnd),this.addEventListener("touchcancel",this.onTouchEnd),this.addEventListener("touchmove",this.onTouchMove)}get size(){return 1*getComputedStyle(this).getPropertyValue("--slice")}set size(e){return this.style.setProperty("--slice",e)}activeFlyBtn(e){e?(this.jump.hasAttribute("active")&&this.inactiveMoveBtn(this.jump),this.jump.style.display="none",this.fly.style.display="",this.activeMoveBtn(this.fly,!1)):(this.fly.hasAttribute("active")&&this.inactiveMoveBtn(this.fly),this.fly.style.display="none",this.jump.style.display="",this.activeMoveBtn(this.jump,!1))}onTouchMove(e){e.cancelable&&e.preventDefault();const t=Object.entries(this.isPress).filter(([s,n])=>n).map(([s])=>this[s]),i=Array.from(e.touches).map(s=>this.shadowRoot.elementFromPoint(s.clientX,s.clientY)).filter(s=>this.btns.includes(s));i.forEach(s=>this.activeMoveBtn(s)),t.forEach(s=>{i.includes(s)||this.inactiveMoveBtn(s)})}onTouchEnd(e){e.cancelable&&e.preventDefault(),Array.from(e.changedTouches).map(i=>this.shadowRoot.elementFromPoint(i.clientX,i.clientY)).filter(i=>this.btns.includes(i)).forEach(i=>this.inactiveMoveBtn(i))}activeMoveBtn(e,t=!0){if(!(!e||this.isPress[e.id])){switch(e.setAttribute("active",""),e){case this.up:{this.upleft.style.display=this.upright.style.display="";break}case this.fly:{this.up.style.display=this.down.style.display="none",this.flyup.style.display=this.flydown.style.display="";break}}this.isPress[e.id]=!0,t&&(this.dispatchEvent(e.id+"BtnPress",{global:!0,data:e}),this.lastBtnPressTime[e.id]===0?this.lastBtnPressTime[e.id]=new Date:new Date-this.lastBtnPressTime[e.id]<250?(this.dispatchEvent(e.id+"BtnDblPress",{global:!0,data:e}),this.lastBtnPressTime[e.id]=0):this.lastBtnPressTime[e.id]=new Date)}}inactiveMoveBtn(e,t=!0){if(!(!e||!this.isPress[e.id])){switch(e.removeAttribute("active"),e){case this.up:case this.upleft:case this.upright:{if(this.up.hasAttribute("active")||this.upleft.hasAttribute("active")||this.upright.hasAttribute("active"))break;this.upleft.style.display=this.upright.style.display="none";break}case this.fly:case this.flyup:case this.flydown:{if(this.fly.hasAttribute("active")||this.flyup.hasAttribute("active")||this.flydown.hasAttribute("active"))break;this.flyup.style.display=this.flydown.style.display="none",this.up.style.display=this.down.style.display="";break}}this.isPress[e.id]=!1,t&&this.dispatchEvent(e.id+"BtnUp",{global:!0,data:e})}}}for(let r of"up,left,down,right,jump,upleft,upright,flyup,flydown,fly,sneak".split(","))rt.setBackgroundAndWaitImg(`mc-ui-move-btn-${r}-img`,`#${r}`),rt.setBackgroundAndWaitImg(`mc-ui-move-btn-${r}-active-img`,`#${r}[active]`);rt.asyncLoadAndDefine();var ae,Se;class Fe extends ne{constructor(){super();te(this,ae,this.shadowRoot.querySelector("input"));te(this,Se,this.shadowRoot.getElementById("progress"));W(this,ae).addEventListener("input",t=>{t.preventDefault(),this.refresh(),this.dispatchEvent("valueChange",{global:!0,data:W(this,ae).value})})}onConnected(){this.initVar()}refresh(){const t=W(this,ae);this.setAttribute("value",t.value),this.hasAttribute("progress")||(W(this,Se).innerHTML=t.value)}initVar(){const t=W(this,ae);t.min=this.getAttribute("min")||0,t.max=this.getAttribute("max")||100,t.step=this.getAttribute("step")||1,t.value=this.getAttribute("value")||50,this.refresh()}static get observedAttributes(){return["label","echo","prefix","progress","unit","min","step","max","value","disabled"]}onAttrChanged(t,i,s){if(t==="echo"){this.shadowRoot.getElementById("default-echo").style.display=s?"none":null;const n=this.shadowRoot.getElementById("specified-echo");n.innerHTML=s,n.style.display=s?null:"none"}else t==="label"||t==="prefix"?this.shadowRoot.querySelector(`[name=${t}]`).innerHTML=s:t==="unit"?this.shadowRoot.querySelector("[name=unit]").innerHTML=s||"%":t==="progress"?W(this,Se).innerHTML=s:t==="disabled"?W(this,ae).disabled=s!==null:this.initVar()}}ae=new WeakMap,Se=new WeakMap;Fe.setBorderAndWaitImg("button-disabled",":host");Fe.setBorderAndWaitImg("slider-thumb","input::-webkit-slider-thumb",{keepCenter:!1});Fe.setBorderAndWaitImg("slider-thumb","input::-moz-range-thumb",{keepCenter:!1});Fe.setBorderAndWaitImg("slider-thumb-hover","input:not(:disabled)::-webkit-slider-thumb:hover",{keepCenter:!1});Fe.asyncLoadAndDefine();var _e,De,Pe,ot;class xe extends ne{constructor(){super();te(this,Pe);te(this,_e,this.shadowRoot.querySelector("slot[name=on]"));te(this,De,this.shadowRoot.querySelector("slot[name=off"));Ne(this,Pe,ot).call(this),this.addEventListener("click",t=>{if(this.disabled)return!1;this.checked=!this.checked,this.dispatchEvent("toggle",{global:!0,data:this.checked})})}onAttrChanged(t,i,s){t==="checked"?Ne(this,Pe,ot).call(this,s!==null):t==="disabled"?this.disabled=s:t==="value"?this.shadowRoot.querySelector("slot").innerHTML=s:t==="sep"?this.shadowRoot.querySelector("slot[name=sep]").innerHTML=s:t==="on"?W(this,_e).innerHTML=s:t==="off"&&(W(this,De).innerHTML=s)}get disabled(){return this.hasAttribute("disabled")}set disabled(t){t?this.setAttribute("disabled",""):this.removeAttribute("disabled")}get checked(){return this.hasAttribute("checked")}set checked(t){this.disabled||(t?this.setAttribute("checked",""):this.removeAttribute("checked"))}}_e=new WeakMap,De=new WeakMap,Pe=new WeakSet,ot=function(t=this.checked){W(this,_e).style.display=t?null:"none",W(this,De).style.display=t?"none":null},q(xe,"observedAttributes",["disabled","value","sep","checked","on","off"]);xe.setBorderAndWaitImg("button",":host");xe.setBorderAndWaitImg("button-hover",":host(:hover)");xe.setBorderAndWaitImg("button-active",":host(:active)");xe.setBorderAndWaitImg("button-disabled",":host([disabled])");xe.asyncLoadAndDefine();const at=(r=0)=>new Promise(e=>setTimeout(e,r)),Yi=(r=1)=>r?new Promise(e=>{const t=()=>r-- >0?window.requestAnimationFrame(t):e();t()}):at();var J,Ve,we;class zi extends ne{constructor(){super();te(this,J,this.shadowRoot.getElementById("input"));te(this,Ve,()=>{const t={x:0,width:0},i="getSelection"in this.shadowRoot?this.shadowRoot:"getSelection"in window?window:null;if(!i)return t;const s=i.getSelection();if(s.rangeCount===0)return t;const n=s.getRangeAt(0).getClientRects()[0];return n&&(t.x=n.left,t.width=n.width),t});te(this,we,async()=>{await Yi();const t=W(this,J);let{x:i,width:s}=W(this,Ve).call(this);if(t.classList.toggle("has-select-text",!!s),t.classList.toggle("blink",!1),!s)if(i){const n=this.getBoundingClientRect().left+this.clientLeft+parseFloat(getComputedStyle(this).paddingLeft);i-=n;const a=t.clientWidth,h=parseFloat(getComputedStyle(t,"::after").width);i<=a-h?t.style.setProperty("--caret-x",i):(t.style.setProperty("--caret-x",a-h),t.scrollLeft+=i-(a-h))}else t.style.setProperty("--caret-x","");await at(500),t.classList.toggle("blink",!0)});this.addEventListener("pointerdown",async()=>{this.disabled||this.shadowRoot.activeElement||(await at(),W(this,J).focus())}),this.addEventListener("pointerup",W(this,we)),this.addEventListener("keydown",t=>{t.keyCode===13&&t.preventDefault()}),this.addEventListener("keyup",W(this,we)),W(this,J).addEventListener("input",W(this,we)),W(this,J).addEventListener("blur",()=>{W(this,J).scrollLeft=0}),this.spellcheck=!1}static get observedAttributes(){return["disabled","value","placeholder","spellcheck"]}onAttrChanged(t,i,s){t==="placeholder"?W(this,J).setAttribute("placeholder",s):t=="value"?this.value=s:t=="spellcheck"?this.spellcheck=s!=null:t=="disabled"&&(this.disabled=s!=null)}get spellcheck(){return W(this,J).spellcheck}set spellcheck(t){W(this,J).spellcheck=!!t}get disabled(){return this.hasAttribute("disabled")}set disabled(t){t?(this.setAttribute("disabled",""),W(this,J).removeAttribute("contenteditable")):(this.removeAttribute("disabled"),W(this,J).setAttribute("contenteditable",""))}get value(){return W(this,J).innerText}set value(t){W(this,J).innerHTML=t.replace(/[\r\n]+/g,"")}}J=new WeakMap,Ve=new WeakMap,we=new WeakMap;zi.asyncLoadAndDefine();window.addEventListener("contextmenu",r=>{r.cancelable&&r.preventDefault()},!0);const Ht=()=>{let r=window.devicePixelRatio;document.documentElement.style.setProperty("--device-pixel-ratio",r),window.dispatchEvent(new Event("dprchange")),matchMedia(`(resolution: ${r}dppx)`).addEventListener("change",Ht,{once:!0})};Ht();localStorage.setItem("mcStorageVer","v0.0.0");
